<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('http://blog.bookbook.in').hostname,
    root: '/',
    scheme: 'Pisces',
    version: '7.7.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="关系、健康、自由，是我的追求。">
<meta property="og:type" content="website">
<meta property="og:title" content="Book Book, Come in~">
<meta property="og:url" content="http://blog.bookbook.in/page/6/index.html">
<meta property="og:site_name" content="Book Book, Come in~">
<meta property="og:description" content="关系、健康、自由，是我的追求。">
<meta property="article:author" content="知明所以">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://blog.bookbook.in/page/6/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false
  };
</script>

  <title>Book Book, Come in~</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Book Book, Come in~</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">知明所以的博客</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.bookbook.in/2014/11/30/%E8%AF%BB%E4%B9%A6/%E8%BF%98%E5%8E%9F%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84%E6%94%BF%E5%95%86%E5%9C%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="知明所以">
      <meta itemprop="description" content="关系、健康、自由，是我的追求。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Book Book, Come in~">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2014/11/30/%E8%AF%BB%E4%B9%A6/%E8%BF%98%E5%8E%9F%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84%E6%94%BF%E5%95%86%E5%9C%88/" class="post-title-link" itemprop="url">《掌舵》读书笔记</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2014-11-30 19:56:00" itemprop="dateCreated datePublished" datetime="2014-11-30T19:56:00+08:00">2014-11-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-01-13 13:00:17" itemprop="dateModified" datetime="2019-01-13T13:00:17+08:00">2019-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%BB%E4%B9%A6/" itemprop="url" rel="index">
                    <span itemprop="name">读书</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          我从来不相信好人必定有好报。这个社会不是因为你是个好人就给你好的回报，而是因为你比别人更了解这个社会的运转机制并做了正确的选择。送礼有送礼的规矩，做生意有做生意的规矩，做官有做官的规矩，要混得好，你得比别人在更多方面都要懂得生存规则。我还坚信的：如果你懂得并遵守了各行各业的规矩，一般来说也会是个好人。
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2014/11/30/%E8%AF%BB%E4%B9%A6/%E8%BF%98%E5%8E%9F%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84%E6%94%BF%E5%95%86%E5%9C%88/">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.bookbook.in/2014/08/21/%E6%8A%80%E6%9C%AF/[%E6%9E%84%E6%9E%B6]%E4%BB%8E%E3%80%87%E5%BC%80%E5%A7%8B%E6%9E%84%E6%9E%B6%E5%89%8D%E7%AB%AF%EF%BC%88NLDV%E6%A1%86%E6%9E%B6%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="知明所以">
      <meta itemprop="description" content="关系、健康、自由，是我的追求。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Book Book, Come in~">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2014/08/21/%E6%8A%80%E6%9C%AF/%5B%E6%9E%84%E6%9E%B6%5D%E4%BB%8E%E3%80%87%E5%BC%80%E5%A7%8B%E6%9E%84%E6%9E%B6%E5%89%8D%E7%AB%AF%EF%BC%88NLDV%E6%A1%86%E6%9E%B6%EF%BC%89/" class="post-title-link" itemprop="url">[构架]从〇开始构架前端（NLDV框架）</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2014-08-21 00:00:00" itemprop="dateCreated datePublished" datetime="2014-08-21T00:00:00+08:00">2014-08-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-01-13 13:00:17" itemprop="dateModified" datetime="2019-01-13T13:00:17+08:00">2019-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>摘要：一个普通应用，大到微信， 小到豆瓣FM，必不可少的都包括四部分：Network、Logic、Data、View（NLDV）。如何把他们组合起来，<strong>结构清晰</strong>、又<strong>协作便利</strong>，是前端主程的基本修养。本文用通（有）俗（点）易（啰）懂（嗦）的语言，界定了这四个模块的职能范围，同时提供了一种简单易用的组织方式。知者可互动，不知者可参考。</p>
<h1 id="先唠点嗑"><a href="#先唠点嗑" class="headerlink" title="先唠点嗑"></a>先唠点嗑</h1><p>说说自己吧：毕业三年，经历4个项目，前两个主做功能开发，后两个全面负责。因为大学对UI交互深感兴趣，梦想成为优秀的交互设计师，所以毕业就做了前端，想着至少也离得近点。不料一入代码深似海，以前看过的十几本交互书也随风而去，脑子里剩下的只有：几行干巴巴的代码、几个平台的API、和一点不成熟的总结。借此机会，整理一下。</p>
<p>我把他名为<strong>NLDV</strong>，也就图一叫着方便（首字母的组合），并不是想标新立异。你或许会想到MVC，其实本质上跟MVC没啥区别。只是与时俱进，现在App几乎都是连着网的，也就把Network提出来了。</p>
<p>从第三个项目开始，这个NLDV的结构在我意识里渐渐清晰。第四个项目（游戏），因为是从零开始，我把NLDV的结构应用到了项目中。经历了渲染引擎更换和网络引擎更换，过程中其它模块儿做得改动极少，切身体会到它的妙处，忍不住前来分享。</p>
<h1 id="从账号登陆谈起"><a href="#从账号登陆谈起" class="headerlink" title="从账号登陆谈起"></a>从账号登陆谈起</h1><p>我们从一个最简单的登陆请求谈起。按照<code>NLDV</code>框架的思想，步骤如下：</p>
<ol>
<li>Logic告诉Network：以后你收到来自远方服务器的消息都跟我打声招呼，不然我告诉程序员整死你丫。(Logic向Network注册网络监听函数。)</li>
<li>用户点击登陆按钮，此时View调用Logic的登录方法。Logic赶紧写封信，告诉Network把这封信送到服务器。（Logic根据传入的参数，构造相应的消息体，Network负责把消息发出去）</li>
<li>漫长的等待。。。</li>
<li>Network终于等到服务器发来的消息，就急急忙忙递给Logic。Logic打开信封一看：“尼玛，居然能一次成功了！32个赞！”<ol>
<li>可是信上还有性别，年龄，头像，邮箱等等等信息，头都大了，不记下来恐怕是隔夜就忘啊。于是，找来Logic的御用秘书Data（只有Logic能写入），这些信息就交给你了，临时存储还是永久存储我不管，反正我和View来取的时候，你要能给我。</li>
<li>好消息要和大家分享，于是Logic全应用广播：“我们已经出色的完成了登陆任务，大家再接再厉”</li>
</ol>
</li>
<li>View收到此广播消息，用界面告诉用户“亲爱的，你登陆成功了”。到此，完成一次登陆。<br> （<em>PS：对于大多数界面实例，Logic刚刚发的这条广播是可以当耳边风的，因为跟自己业务无关。但，对于登陆界面来说，他必须时刻竖起耳朵监听这个消息，要不然就是失职。所以一般情况下登陆View会在发送登录请求之前就向系统注册监听这个消息的函数，以确保万无一失。这是后话，没看懂也没关系</em>）</li>
</ol>
<h1 id="职责分配"><a href="#职责分配" class="headerlink" title="职责分配"></a>职责分配</h1><p>首先，看一幅图：<br><img src="How%20to%20use%20the%20Public%20folder.png" alt="NLDV Diagram" title="NLDV Dirgram">  </p>
<p>通过上面的例子和图示，可以来总结一下NLDV四大家族各自的职能范围了：</p>
<h2 id="Network"><a href="#Network" class="headerlink" title="Network"></a>Network</h2><p>Network的是数据交流的基础。在这里并不单指socket，并且不暴露任何底层网络的实现。而是一个更加完整、稳定，有纠错功能的职能单位。主要功能：</p>
<ul>
<li>响应Logic的调用，将构造好的消息体转换成服务器能识别的字节串，发送出去。</li>
<li>接收服务器发过来的字节串，转换成前端可识别的结构体，通知Logic。<ul>
<li>前后端在定义消息的时候，一般会用一个消息号(/或 <code>主消息号-子消息号</code>对）来唯一标识一种消息。</li>
<li>而Logic也不止一个，账号系统，业务系统等，每个系统有对应的Logic，分别处理相关的业务逻辑。</li>
<li>一个Logic仅仅会对某一些消息感兴趣，所以，它只向Network注册自己感兴趣的消息号。</li>
</ul>
</li>
<li>容错处理。比如有限次的自动重发，需要的时候自动重连，网络彻底不可用时通知Logic等。</li>
</ul>
<p>我们用最少的接口来定义它：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Real msg struct will implement this interface, adding some getter/setters.</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IMessage</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function">uint <span class="title">getMsgId</span><span class="params">()</span></span>;<span class="comment">// unique id for a type of msg</span></span><br><span class="line">    <span class="keyword">byte</span>[] toBytes();<span class="comment">// serialize to bytes.</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">parseBytes</span><span class="params">( <span class="keyword">byte</span>[] bytes)</span></span>; <span class="comment">//deserialize to useful info.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Generally, "Logic" will implement this interface for recieving data</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">INetworkHandler</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onMessageRecv</span><span class="params">( IMessage msg)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">INetwork</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">send</span><span class="params">( IMessage msg )</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">registHandler</span><span class="params">( uint msgId, INetworkHandler handler )</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">unregistHandler</span><span class="params">( uint msgId, INetworkHandler handler )</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Logic"><a href="#Logic" class="headerlink" title="Logic"></a>Logic</h2><p>Logic是一个应用中核心实现业务逻辑的部分。主要功能有： </p>
<ul>
<li>响应来自用户（View）的功能请求。或通过写入Data来改变状态，或构造消息体发送到服务器。</li>
<li>收到网络消息后，做相应的逻辑处理，将数据的改变写入Data，最后广播本地事件。<ul>
<li>这里的本地事件通常用一个 字符串或者整数指代，称为本地事件ID。</li>
<li>这个过程通常会用到<a href="http://baike.baidu.com/view/1854779.htm" target="_blank" rel="noopener">观察者模式</a>。有一个本地消息中心<code>LocalMessageCenter</code>，监听者（通常是View）用本地事件ID来向<code>LocalMessageCenter</code>注册，而Logic调用<code>LocalMessageCenter.dispatch( localEventId )</code> 即可广播此本地事件。</li>
<li>是的，Logic直接调用View的方法也能达到同样的目的。但是，为了减小Logic和View之间的耦合性，还是选用<code>LocalMessageCenter</code>作为中间层。随着需求的改变，View类可能面目全非，但<code>LocalMessageCenter</code>的接口却可以长久不变。</li>
</ul>
</li>
</ul>
<p>Logic的大致结构如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SomeLogic</span> <span class="title">implemets</span> <span class="title">INetworkHandler</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    SomeLogic()</span><br><span class="line">    &#123;</span><br><span class="line">        Network.getInstance().registHandler(<span class="number">1</span>, <span class="keyword">this</span>);</span><br><span class="line">        Network.getInstance().registHandler(<span class="number">2</span>, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onMessageRecv</span><span class="params">( IMessage msg)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span>( msg.getMsgId() )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                logicHandler1(IMessage msg);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                logicHandler2(IMessage msg);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//请求操作</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">logicReq1</span><span class="params">(...)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">logicReq2</span><span class="params">(...)</span></span>;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//消息处理</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">logicHandler1</span><span class="params">(IMessage msg)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//<span class="doctag">TODO:</span> 收到消息，逻辑处理</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//<span class="doctag">TODO:</span> 向Data写入数据</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//<span class="doctag">TODO:</span> 广播本地事件</span></span><br><span class="line">        LocalMessageCenter.getInstance().dispatch( <span class="string">"Logic1Compelete"</span> );</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">logicHandler2</span><span class="params">(IMessage msg)</span></span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ILocalMessageHandler</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onLocalMessage</span><span class="params">( String msg )</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">LocalMessageCenter</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> LocalMessageCenter <span class="title">getInstance</span><span class="params">()</span></span>; <span class="comment">// Singleton</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dispatch</span><span class="params">( String msg )</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">regist</span><span class="params">( String msg, ILocalMessageHandler handler )</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">unregist</span><span class="params">( String msg, ILocalMessageHandler handler )</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Data"><a href="#Data" class="headerlink" title="Data"></a>Data</h2><p>这个模块是全应用的数据中心。提供两个功能：</p>
<ul>
<li><strong>存储</strong>。前面已经提到，基本只有Logic对Data有写入权限。由于没有想到好的办法，这个规范暂时只能通过编码习惯来约定，没有做框架级的约定，如果大家有好的办法，欢迎补充。Logic 不关心数据的存储方式：同步OR异步，临时OR永久；这些都由Data自己决定。</li>
<li><strong>读取</strong>。Logic和View都会使用到Data中的数据。但是<strong>需要注意异步读取的问题</strong>。一般App要求View对操作的响应速度要在0.1s级别。所以，若涉及大量的数据存储或读取，便需要借助异步处理。对于存储，我们可能不是那么关心异步存储什么时候结束，只需要知道它成功了既可。但对于读取，经常遇到的情况是：页面上加个菊花，数据完全读取成功之后，移除菊花。这就需要一个通知机制。此时，我们也会用<code>LocalMessageCenter</code>作为通信的桥梁。</li>
</ul>
<h2 id="View"><a href="#View" class="headerlink" title="View"></a>View</h2><p>NLDV框架对View的限制，相比以上3个模块，非常少。因为，对于NLDV框架来说，View跟特定的平台无关，即它是对各种不同平台显示框架的抽象。在<code>IOS</code>里它是<code>UIFramework</code>,在<code>Android</code>里它是<code>xxx</code>，在游戏里它是<code>openGL</code>，甚至，在下面会讲到的机器人模拟器里它是一堆测试代码。</p>
<p>在这个框架里，View只在两个过程中出现：</p>
<ol>
<li>调用Logic的方法，发送逻辑请求。</li>
<li>监听本地事件，读取Data，显示内容。</li>
</ol>
<p>只补充一点：在View显示过程中，需要用到很多二级数据（二级数据，就是跟原始数据相对，对原始数据进行整合或者筛选后得到的数据），这些二级数据的处理过程最好在View中处理。因为这些代码大多跟特定的界面有关，而跟App的主要逻辑关系不大，为了以后更改方便，最好写在View里。</p>
<h1 id="WHY-NLDV"><a href="#WHY-NLDV" class="headerlink" title="WHY NLDV?"></a>WHY NLDV?</h1><p>看到这里，读者大概能隐约的感受到NLDV的一些优点，但是又不那么清晰，要不要看下去呢？下个里程碑就到了看这个人扯淡有用么？再看下去两盘Dota的时间可就没了丫。。。</p>
<p>别急，举几个栗子提提神。</p>
<h2 id="引擎更换"><a href="#引擎更换" class="headerlink" title="引擎更换"></a>引擎更换</h2><p>最早，因为兼容PC版本的斗地主，我们采用了原始的字节对齐的方式进行网络传输。又因为设计失误，网络层字节的pack和unpack以及异步读取的处理，都各种出问题。（因为需要跨平台，所以我们用了C++语言，采用了最基础的BSD socket进行socket连接。）</p>
<p>结果是，游戏在网络不稳定的情况下各种闪退。这下产品经理不高兴了。又因为当初开发网络层的同学接手了其他事情，只剩下我各种修修补补，最终也没能彻底解决问题。</p>
<p>于是，我决定重写网络层。（妈蛋，早看这段代码不爽了）。于是我花了两天封装了一个带自动重连和容错功能，支持异步接受和发送的<code>GameSocket</code>，简单测试可以发送和接受字节。5分钟替换游戏中的旧网络层，你猜，怎么着？一次Run就登陆成功了！点了几下，所有功能完好如初！尼玛，世界上有比这还幸福的事情么？</p>
<p>其实，别听我说的挺牛逼的，其实替换过程就改了不到10行代码。因为实在是跟Logic、Data、View没啥耦合的地方。</p>
<h2 id="制作机器人"><a href="#制作机器人" class="headerlink" title="制作机器人"></a>制作机器人</h2><p>一般在线游戏，都会有一两个用户没问题，大量用户就有问题的时候。所以，机器人测试总是必要的。</p>
<p>当我把前端代码交给后端，简单介绍了一下结构之后，后端的小伙伴儿们都惊呆了。不是因为他看到这框架有多么优秀，而是：“这样，我只要写一个while循环，500行代码就能完成一个机器人了啊。我还申请了一个星期来做这个事情呢！”（这是他的原话）。</p>
<p>说的更具体点，制作一个机器人就这么几步：</p>
<ol>
<li>把所有的View代码文件删掉。</li>
<li>写一个<code>AndroidLoop</code>类。在这个类里，监听斗地主主流程里必须处理的<code>LocalMessage</code>，在适当的时候发送主流程中的请求。（对于斗地主来说，主流程包括登陆、选房间、抢地主、出牌、退房间。每个应用有所不同，灵活自便。）</li>
<li>NLD（NLDV去掉V）部分都不变，几乎不用改一行代码。</li>
</ol>
<h2 id="逻辑清晰"><a href="#逻辑清晰" class="headerlink" title="逻辑清晰"></a>逻辑清晰</h2><p>框架的作用，理论层面上规范了整个软件的结构；而在实现层面，通俗一点，它就规范了<strong>什么代码该写在哪里，不要随地乱放</strong>。</p>
<p>作为一个针对性很强的框架，在上述过程中，NLDV约束了很多可能不需要约束的规范。其中大部分是项目中的干货经验。我知道他并不总是好的，我考略了很久要不要把他们加进来。最终，我还是写下来了，考虑到刚开始从零开始写应用的读者来说，这些可能避免他们走很多弯路；而对有经验的读者来说，可能他们有判断的能力，可以取舍自如。</p>
<p>我想，如果严格按照NLDV框架来编写程序，显而易见的好处就是：</p>
<ol>
<li>层次清晰，出现问题容易定位。</li>
<li>主程再也不用担心同事们把代码写得到处都是了。。。</li>
</ol>
<h1 id="框架之外（下回分解）"><a href="#框架之外（下回分解）" class="headerlink" title="框架之外（下回分解）"></a>框架之外（下回分解）</h1><h1 id="NLDV的适用场景（下回分解）"><a href="#NLDV的适用场景（下回分解）" class="headerlink" title="NLDV的适用场景（下回分解）"></a>NLDV的适用场景（下回分解）</h1><p>因为各种原因，这篇博客断断续续写了两个星期了，再不发布就要胎死腹中了。所以，最后两节放在这篇日志的续集中写。如果您感兴趣，请私信我，我会尽快补上。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.bookbook.in/2014/08/11/%E8%AF%BB%E4%B9%A6/%E5%A6%82%E4%BD%95%E9%98%85%E8%AF%BB%E4%B8%80%E6%9C%AC%E4%B9%A6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="知明所以">
      <meta itemprop="description" content="关系、健康、自由，是我的追求。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Book Book, Come in~">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2014/08/11/%E8%AF%BB%E4%B9%A6/%E5%A6%82%E4%BD%95%E9%98%85%E8%AF%BB%E4%B8%80%E6%9C%AC%E4%B9%A6/" class="post-title-link" itemprop="url">《如何阅读一本书》读书笔记</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2014-08-11 09:14:00" itemprop="dateCreated datePublished" datetime="2014-08-11T09:14:00+08:00">2014-08-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-01-13 13:00:17" itemprop="dateModified" datetime="2019-01-13T13:00:17+08:00">2019-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%BB%E4%B9%A6/" itemprop="url" rel="index">
                    <span itemprop="name">读书</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          每本书的封面之下都有一套自己的骨架，作为一个分析阅读的读者，你的责任就是要找出这个骨架。一本书出现在你面前时，肌肉包着骨头，衣服包裹着肌肉，可说是盛装而来。你用不着揭开它的外衣或是撕去它的肌肉，才能得到在柔软表皮下的那套骨架。但是你一定要用一双X光般的透视眼来看这本书，因为那是你了解一本书、掌握其骨架的基础。
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2014/08/11/%E8%AF%BB%E4%B9%A6/%E5%A6%82%E4%BD%95%E9%98%85%E8%AF%BB%E4%B8%80%E6%9C%AC%E4%B9%A6/">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.bookbook.in/2014/08/05/%E6%89%AF%E6%B7%A1/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E5%86%99%E5%8D%9A%E5%AE%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="知明所以">
      <meta itemprop="description" content="关系、健康、自由，是我的追求。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Book Book, Come in~">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2014/08/05/%E6%89%AF%E6%B7%A1/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E5%86%99%E5%8D%9A%E5%AE%A2/" class="post-title-link" itemprop="url">我为什么写博客</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2014-08-05 00:00:00" itemprop="dateCreated datePublished" datetime="2014-08-05T00:00:00+08:00">2014-08-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-01-13 13:00:17" itemprop="dateModified" datetime="2019-01-13T13:00:17+08:00">2019-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%89%AF%E6%B7%A1/" itemprop="url" rel="index">
                    <span itemprop="name">扯淡</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          屌丝程序员的逆袭一般分两步：让自己变得牛逼, 让别人知道你牛逼. 我通过写博客来让自己更擅长归纳和抽象, 也通过写博客来让别人知道我能胜任某份工作.
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2014/08/05/%E6%89%AF%E6%B7%A1/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E5%86%99%E5%8D%9A%E5%AE%A2/">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.bookbook.in/2014/07/22/%E6%8A%80%E6%9C%AF/[cocos2dx]2.2%E5%88%B03.1(3.0)%E5%8D%87%E7%BA%A7%E5%B8%AE%E5%8A%A9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="知明所以">
      <meta itemprop="description" content="关系、健康、自由，是我的追求。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Book Book, Come in~">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2014/07/22/%E6%8A%80%E6%9C%AF/%5Bcocos2dx%5D2.2%E5%88%B03.1(3.0)%E5%8D%87%E7%BA%A7%E5%B8%AE%E5%8A%A9/" class="post-title-link" itemprop="url">[cocos2dx]2.2到3.1(3.0)升级帮助</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2014-07-22 00:00:00" itemprop="dateCreated datePublished" datetime="2014-07-22T00:00:00+08:00">2014-07-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-01-13 13:00:17" itemprop="dateModified" datetime="2019-01-13T13:00:17+08:00">2019-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>摘要: cocos2dx 是一款<strong>优秀的多平台,专为2D游戏设计的引擎</strong>. 在活跃的开源社区的推进下, 越发稳定和强大. 2.x -&gt; 3.x的更新幅度很大, 性能的提升和功能的丰富也非常明显. 但在享受<strong>进步</strong>的同时,也要承受<strong>迁徙</strong>之苦. 本文主要是总结自己迁徙的经历, 以防大家走弯路.</p>
<hr>
<h2 id="基础准备"><a href="#基础准备" class="headerlink" title="基础准备"></a>基础准备</h2><ol>
<li>我一直把VS当作主开发环境, eclipse和xcode作为特定机型的调试环境. 所以, 偷个懒, <strong>假设你也在用VS开发</strong>. 另外两个平台也也都有<a href="http://zh.wikipedia.org/zh-hant/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F" target="_blank" rel="noopener">正则表达式</a>替换功能, 大同小异.</li>
<li>在这里, <strong>假设你已经搭好了3.x的VS开发环境</strong>, 能正常运行<code>HelloWorld</code>演示.</li>
<li><strong>假设你有一定的正则表达式基础</strong>. 如果没有的话, 可参考这篇速成教程:<a href="http://deerchao.net/tutorials/regex/regex.htm" target="_blank" rel="noopener">正则表达式30分钟入门教程</a></li>
</ol>
<h2 id="进入正题"><a href="#进入正题" class="headerlink" title="进入正题"></a>进入正题</h2><p>cocos2dx 3.1的简要feature更新介绍可参考<a href="https://github.com/cocos2d/cocos2d-x#main-features" target="_blank" rel="noopener">这里</a>, 详细的<code>changelog</code>可参考<a href="https://github.com/cocos2d/cocos2d-x/blob/v3/CHANGELOG" target="_blank" rel="noopener">这里</a>.在升级之前, 建议扫一遍<code>changelog</code>( 否则都不知道要做啥…).</p>
<p>接下来, 进入正题啦:</p>
<h3 id="语法更新"><a href="#语法更新" class="headerlink" title="语法更新"></a>语法更新</h3><p>本文将有非常多字符串替换的步骤, 都在vs2012中进行. vs2012中字符串替换窗口如下:<br><img src="o_Image.png" alt="此处是vs窗口截图"><br>本文将上图代表的替换表示为:( 以后将不特殊说明 )</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;regex-replace</span><br><span class="line">\bUIImageView\b &#x3D;&#x3D;&gt; ui::ImageView</span><br></pre></td></tr></table></figure>
<h4 id="obj-c式命名-gt-c-命名空间式命名"><a href="#obj-c式命名-gt-c-命名空间式命名" class="headerlink" title="obj-c式命名 ==&gt; c++命名空间式命名"></a><a id="objc2cpp"></a>obj-c式命名 ==&gt; c++命名空间式命名</h4><p>以下是常见的替换:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;regex-replace</span><br><span class="line">&#x2F;&#x2F;Widget:</span><br><span class="line">\bUIWidget\b                                &#x3D;&#x3D;&gt; ui::Widget</span><br><span class="line">\bUIImageView\b                             &#x3D;&#x3D;&gt; ui::ImageView</span><br><span class="line">\bUIButton\b                                &#x3D;&#x3D;&gt; ui::Button</span><br><span class="line">...                                     </span><br><span class="line">\bUILayout\b                                &#x3D;&#x3D;&gt; ui::Layout</span><br><span class="line">\bUILabel\b                                 &#x3D;&#x3D;&gt; ui::Text</span><br><span class="line">\bUILayer\b                                 &#x3D;&#x3D;&gt; Layer</span><br><span class="line">\bCCObject\b                                &#x3D;&#x3D;&gt; Ref</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">\baddTouchEventListener\s*\(\s*(.+)\s*,\s*toucheventselector\s*\((.*)\)\s*\)  &#x3D;&#x3D;&gt; addTouchEventListener( CC_CALLBACK_2( $2, $1 ))</span><br><span class="line">\bTouchEventType\b                          &#x3D;&#x3D;&gt; ui::Widget::TouchEventType</span><br><span class="line">\bTOUCH_EVENT_([A-Z]+)\b                    &#x3D;&#x3D;&gt; ui::Widget::TouchEventType::$1</span><br><span class="line">\baddWidget\b\s*\(                          &#x3D;&#x3D;&gt; addChild(</span><br></pre></td></tr></table></figure>

<p>注释: <code>\b</code>代表单词的分割符. <code>()</code>代表被标记的内容, <code>$1</code> 代表原始字符串中被标记的内容中的第一段. 具体请参考<a href="http://msdn.microsoft.com/query/dev11.query?appId=Dev11IDEF1&l=ZH-CN&k=k(vs.netregularexpressionhelp)&rd=true" target="_blank" rel="noopener">在 Visual Studio 中使用正则表达式</a>.</p>
<h4 id="include文件变更"><a href="#include文件变更" class="headerlink" title="include文件变更"></a>include文件变更</h4><p>因为包结构的变化, 所以有些组件的定义会未被include.<br>主要用到的head文件有:</p>
<table>
<thead>
<tr>
<th>head</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>cocos2d.h</code></td>
<td>cocos2dx的基本数据类和Node类都包含在里面</td>
</tr>
<tr>
<td><code>ui/CocosGUI.h</code></td>
<td>cocos2dx 绝大部分的UI类都包含在内. 2.x版本中, UI类都包含在<code>cocos-ext.h</code>中. 所以绝大部分原来引用<code>cocos-ext.h</code>的地方都需要引用此文件</td>
</tr>
<tr>
<td><code>cocostudio/CocoStudio.h</code></td>
<td>cocostudio功能相关的类都包含在里面. 最主要的是各种读取json文件的Reader. 其次, 是<code>Armature</code>动画.</td>
</tr>
<tr>
<td><code>cocos-ext.h</code></td>
<td>相比2.x的<code>cocos-ext.h</code>, 此文件做了非常大的精简. 现在主要包括<code>CCScrollView</code>及其子类, 另外还有<code>EditBox</code></td>
</tr>
</tbody></table>
<h4 id="std-function作为监听函数"><a href="#std-function作为监听函数" class="headerlink" title="std::function作为监听函数"></a>std::function作为监听函数</h4><p>虽然, 3.1 的版本仍然支持绝大多数老版本的回调函数方式, 比如: <code>m_btnSubmit-&gt;addTouchEventListener (this,toucheventselector(RewardItemCell::onBtnSubmitClick));</code>仍然能工作. 但是, 不能保证在将来的3.x版本中仍然如此. 所以, 尽量一次搞定吧. 在<a href="#objc2cpp">obj-c式命名 ==&gt; c++命名空间式命名</a>章节中, 有批量替换的正则表达式,可作为参考.</p>
<h3 id="功能更新"><a href="#功能更新" class="headerlink" title="功能更新"></a>功能更新</h3><h4 id="中间层UILayer的去除"><a href="#中间层UILayer的去除" class="headerlink" title="中间层UILayer的去除"></a>中间层<code>UILayer</code>的去除</h4><p>在2.x版本, <code>Widget</code>需要作为<code>UILayer</code>的孩子节点才能响应触摸事件; 而在3.x版本中取消了这个限制, <code>Widget</code>的响应机制变为跟<code>Menu</code>类似. 目前, 我也没有大量的去掉之前的<code>UILayer</code>层, 大部分功能仍然正常工作.</p>
<h4 id="键盘响应方式变更"><a href="#键盘响应方式变更" class="headerlink" title="键盘响应方式变更"></a>键盘响应方式变更</h4><p>在2.x版本中, 键盘响应的监听是用<code>CCDirector::sharedDirector()-&gt;getKeypadDispatcher()-&gt;addDelegate(this);</code>实现的. 在3.x版本中是这样:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">auto keyListener &#x3D; EventListenerKeyboard::create();</span><br><span class="line">keyListener-&gt;onKeyReleased &#x3D; CC_CALLBACK_2(MainScene::keyBackClicked, this);</span><br><span class="line">_eventDispatcher-&gt;addEventListenerWithSceneGraphPriority(keyListener, this);</span><br></pre></td></tr></table></figure>
<p>监听的取消, 也要做响应的替换.</p>
<h4 id="Armature的陷阱"><a href="#Armature的陷阱" class="headerlink" title="Armature的陷阱"></a>Armature的陷阱</h4><p>在2.x版本中, 一般通过下面的方式来监听<code>Armature</code>的事件. 在监听到<code>COMPLETE</code>的时候, 可以将此<code>Armature</code>移出场景.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CCArmature* swf &#x3D; CCArmature::create(swfName);</span><br><span class="line">swf-&gt;getAnimation()-&gt;setMovementEventCallFunc(this, movementEvent_selector(OutCardEffectHelper::onAnimationEnd));</span><br></pre></td></tr></table></figure>

<p>但是在3.x中, 我们不能在监听事件的回调函数中做任何可能会导致<code>release</code>此对象的操作. 否则, 会导野指针错误.<br>是不是有点鸡肋? 我们来看看这种情况是怎么发生的:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Scheduler-&gt;Armature:update(t)</span><br><span class="line">Armature-&gt;ArmatureAnimation:update(t)</span><br><span class="line">ArmatureAnimation-&gt;this:告诉监听者</span><br><span class="line">Note right of this:假设此时触发了COMPLETE事件</span><br><span class="line">Note right of this: this-&gt;remove Armature, release Armature</span><br><span class="line">Armature-&gt;Bone: update(t)</span><br><span class="line">Note right of Armature: set &#96;_armatureTransformDirty &#x3D; false&#96;</span><br><span class="line">Note right of Armature: but now, Armature has been RELEASED!!!</span><br></pre></td></tr></table></figure>

<p>我临时用定时器来移除<code>Armature</code>的. 具体过程如下:</p>
<ol>
<li>为<code>ArmatureAnimation</code>增加一个公开函数:  <code>virtual MovementData *getMovementData() const { return _movementData; }</code></li>
<li>通过下面的方式来移除: (PS: Lmada 表达式真是好用啊啊啊啊啊 )</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">auto data &#x3D; swf-&gt;getAnimation()-&gt;getMovementData();</span><br><span class="line">float speed &#x3D; data-&gt;scale;</span><br><span class="line">float frames &#x3D; data-&gt;duration;</span><br><span class="line">float delay &#x3D; frames&#x2F;60&#x2F;speed;</span><br><span class="line">string id &#x3D; FORMAT_TEXT( &quot;%p&quot;, swf );</span><br><span class="line">Director::getInstance()-&gt;getScheduler()-&gt;schedule( [swf](float t)&#123;swf-&gt;removeFromParent();&#125;,this,0,0,delay,false, id);</span><br></pre></td></tr></table></figure>
<h4 id="更加优雅的anchorPoint"><a href="#更加优雅的anchorPoint" class="headerlink" title="更加优雅的anchorPoint"></a>更加优雅的anchorPoint</h4><p>如果你加载了cocostudio生成的ui json文件, 并改动过内部<code>Widget</code>的位置的话, 你会发现, 代码中<code>x=20</code>跟cocostudio ui编辑器中<code>x=20</code>效果是不一样的.<br>问题出在哪里呢?<br>简单来说, 2.x版本中的<code>anchorPoint</code>对自己在父亲节点的位置和孩子节点在自己中的位置都有影响; 3.x版本中的<code>anchorPoint</code>只对自己在父亲节点中的位置有影响.</p>
<p>举个例子. 假设A是父亲节点,B是A的孩子节点. A和B同为10*10的正方形.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">A.anchorPoint &#x3D; Point(0.5,0.5);</span><br><span class="line">A.setSize(Size(10,10))</span><br><span class="line">B.anchorPoint &#x3D; Point(0.5,0.5);</span><br><span class="line">B.setSize(Size(10,10))</span><br><span class="line">B.setPosition( Point::ZERO );</span><br><span class="line">A.addChild(B);</span><br></pre></td></tr></table></figure>
<p>在2.x版本中: A和B的位置完全重合<br>在3.x版本中: B的中心点和A的左下角的点重合.</p>
<p><img src="o_Untitled%20Diagram.png" alt="此处是位置示意图"></p>
<h4 id="Sprite的默认GLProgram"><a href="#Sprite的默认GLProgram" class="headerlink" title="Sprite的默认GLProgram"></a>Sprite的默认GLProgram</h4><p>什么?你没听过<code>GLProgram</code>, 那恭喜你, 可以跳过这小节了. 因为你肯定不会出现下面的恼人情况.</p>
<p><code>SHADER_NAME_POSITION_TEXTURE_COLOR</code>是2.x版本中的默认<code>GLProgram</code>. 它对应的vect和frag分别是:<code>ccPositionTextureColor_vert</code>和<code>ccPositionTextureColor_frag</code>. vect用来确定位置,frag用来确定色彩.  </p>
<p>然而, 在3.x版本中,默认的<code>GLProgram</code>是<code>SHADER_NAME_POSITION_TEXTURE_COLOR_NO_MVP</code>, 对应的vect和frag分别是:<code>ccPositionTextureColor_noMVP_vert</code>和<code>ccPositionTextureColor_noMVP_frag</code>.</p>
<p>如果你恰好用过<code>ccPositionTextureColor_vert</code>的话, 建议改为<code>ccPositionTextureColor_noMVP_vert</code>. 否则会出现莫名的位置偏移问题.</p>
<h4 id="stl-vector的不稳定排序导致的层级问题"><a href="#stl-vector的不稳定排序导致的层级问题" class="headerlink" title="stl::vector的不稳定排序导致的层级问题"></a>stl::vector的不稳定排序导致的层级问题</h4><p>2.x版本中, 如果没有对孩子设置过<code>zOrder</code>的话, 孩子节点的覆盖顺序为: 后加的节点在上层, 先加的节点在下层.</p>
<p>3.x版本中, win32环境下, 孩子节点的覆盖层级还能保续. 但是在android平台下, <code>zOrder</code>相同的孩子, 层级顺序是随机的. 关键在下面的代码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">void Node::sortAllChildren()</span><br><span class="line">&#123;</span><br><span class="line">    if( _reorderChildDirty ) &#123;</span><br><span class="line">        std::sort( std::begin(_children), std::end(_children), nodeComparisonLess );</span><br><span class="line">        _reorderChildDirty &#x3D; false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>win32和android平台对<code>stl::sort()</code>的实现不同, android下的排序算法不是稳定的. 解决方法:</p>
<ol>
<li>修改上述代码, 实现稳定排序</li>
<li>添加孩子节点的时候手动设置<code>zOrder</code>来保证层级顺序.</li>
</ol>
<h4 id="umeng等第三方库的更新"><a href="#umeng等第三方库的更新" class="headerlink" title="umeng等第三方库的更新"></a>umeng等第三方库的更新</h4><p>第三方库, 也有很多跟cocos2dx版本相关. 注意升级, 否则会闪退.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.bookbook.in/2014/07/22/%E6%8A%80%E6%9C%AF/[cocos2dx]%E6%B7%B1%E5%85%A5--%E5%87%A0%E4%B8%AA%E4%BB%A3%E8%A1%A8%E6%80%A7%E7%9A%84%E7%B1%BB%20(%E7%BB%AD)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="知明所以">
      <meta itemprop="description" content="关系、健康、自由，是我的追求。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Book Book, Come in~">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2014/07/22/%E6%8A%80%E6%9C%AF/%5Bcocos2dx%5D%E6%B7%B1%E5%85%A5--%E5%87%A0%E4%B8%AA%E4%BB%A3%E8%A1%A8%E6%80%A7%E7%9A%84%E7%B1%BB%20(%E7%BB%AD)/" class="post-title-link" itemprop="url">[cocos2dx]深入了解几个代表性的类 (续)</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2014-07-22 00:00:00" itemprop="dateCreated datePublished" datetime="2014-07-22T00:00:00+08:00">2014-07-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-01-13 13:00:17" itemprop="dateModified" datetime="2019-01-13T13:00:17+08:00">2019-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>摘要: 此文对<code>cocos2d-x</code>引擎中最具代表性,最能体现框架结构的几个类做了简单的介绍, 包括<code>Director</code>,<code>Application</code>, <code>Renderer</code>, <code>EventDispatcher</code>, <code>Scheduler</code>. 对于这些类, 也只对关系主要流程的方法做了介绍, 略过了容错代码和其它细节. 主要目的是让大家快速的对<code>cocos2d-x</code>引擎有一个全面笼统的认识, 也方便快速定位问题.</p>
<hr>
<h1 id="EventDispatcher"><a href="#EventDispatcher" class="headerlink" title="EventDispatcher"></a>EventDispatcher</h1><h2 id="EventDispatcher-EventListener-Event之间的关系"><a href="#EventDispatcher-EventListener-Event之间的关系" class="headerlink" title="EventDispatcher,EventListener,Event之间的关系"></a>EventDispatcher,EventListener,Event之间的关系</h2><ul>
<li><code>EventDispatcher</code>: 事件分发器, 相当于所有事件的中控中心. 管理着<code>EventListener</code>，当一个<code>Event</code>到来的时候决定<code>CallBack</code>的调用顺序。</li>
<li><code>Event</code> ( <code>EventTouch</code>, <code>EventKeyboard</code> 等), 具体的事件数据, </li>
<li><code>EventListener</code> ( <code>EventListenerTouch</code>, <code>EventListenerKeyboard</code> 等 ): 建立了<code>Event</code>到<code>CallBack</code>的映射关系, <code>EventDispatcher</code> 根据这种映射关系调用对应的 <code>CallBack</code>.</li>
</ul>
<h2 id="Event"><a href="#Event" class="headerlink" title="Event"></a>Event</h2><p><code>Event</code>有以下几种类型:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">enum class Type</span><br><span class="line">&#123;</span><br><span class="line">    TOUCH,</span><br><span class="line">    KEYBOARD,</span><br><span class="line">    ACCELERATION,</span><br><span class="line">    MOUSE,</span><br><span class="line">    FOCUS,</span><br><span class="line">    CUSTOM</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>Event</code>最重要的属性就是<code>type</code>, 标识了它是那种类型的事件, 也决定了由哪个<code>EventListner</code>来处理它.</p>
<h2 id="EventListener"><a href="#EventListener" class="headerlink" title="EventListener"></a>EventListener</h2><p><code>EventListner</code>有以下几种类型:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">enum class Type</span><br><span class="line">&#123;</span><br><span class="line">    UNKNOWN,</span><br><span class="line">    TOUCH_ONE_BY_ONE,</span><br><span class="line">    TOUCH_ALL_AT_ONCE,</span><br><span class="line">    KEYBOARD,</span><br><span class="line">    MOUSE,</span><br><span class="line">    ACCELERATION,</span><br><span class="line">    FOCUS,</span><br><span class="line">    CUSTOM</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>除了<code>UNKNOWN</code>, 跟<code>Event::Type</code>相比,<code>Event::Type::TOUCH</code>会<strong>同时</strong>被两种类型的<code>EventListener</code>处理: <code>TOUCH_ONE_BY_ONE</code>和<code>TOUCH_ALL_AT_ONCE</code>. 这两种<code>EventListener</code>分别处理单点触摸事件和多点触摸事件. 多说几句: 假如一个<code>TouchEvent</code>事件中有多个触摸点, 那么类型为 <code>EventListener::Type::TOUCH_ONE_BY_ONE</code> 的 <code>EventListener</code> 会把这个事件分解成若干个单点触摸事件来处理. 而类型为 <code>EventListener::Type::TOUCH_ALL_AT_ONCE</code> 的 <code>EventListener</code> 就是来处理多点触摸的, 会一次处理它.<br>其它几种类型都是一一对应的, 即一种<code>Event::Type</code>的<code>Event</code>会被对应类型的<code>EventListener</code>接受.</p>
<h2 id="存放-EventListener-的地方"><a href="#存放-EventListener-的地方" class="headerlink" title="存放 EventListener 的地方"></a>存放 EventListener 的地方</h2><p>在<code>EventDispatcher</code>中, 它把以上7种 <code>EventListener::Type</code> 类型的 <code>EventListner</code> 放到7个队列中. 也就是在这样一个字段中:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">std::unordered_map&lt;EventListener::ListenerID, EventListenerVector*&gt; _listenerMap;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>EventListener::ListenerID</code> : 每一种<code>EventListener::Type</code>有唯一的 <code>EventListener::ListenerID</code>. 其实通过这段代码 <code>typedef std::string ListenerID;</code> 可知: <code>EventListener::ListenerID</code> 就是简单 <code>string</code>, 就是一个名称而已.</li>
<li><code>EventListenerVector</code>: 顾名思义, 就是一个 <code>EventListener</code> 的向量容器. 相对于普通的向量容器, 它增加了<code>priority</code>管理功能. </li>
</ul>
<h2 id="EventListener的fixedPriority"><a href="#EventListener的fixedPriority" class="headerlink" title="EventListener的fixedPriority"></a>EventListener的fixedPriority</h2><p>简单来说, 每个 <code>EventListener</code> 有自己的 <code>fixedPriority</code> 属性, 它是一个整数. </p>
<h3 id="EventListener的遍历顺序"><a href="#EventListener的遍历顺序" class="headerlink" title="EventListener的遍历顺序"></a>EventListener的遍历顺序<a name="priority_of_event_listener"></a></h3><p><code>EventDispatcher</code> 在抛发事件的时候, 会先处理 <code>Event</code> 的时候, 会优先遍历 <code>fixedPriority</code> 低的 <code>EventListener</code>, 调用它的 <code>CallBack</code>. 在某些条件下, 一个 <code>Event</code> 被一个 <code>EventListener</code> 处理之后, 会停止遍历其它的 <code>EventListener</code>. 反映到实战中就是: 你监听了某种事件, 这种事件也出发了, 但是对应的回调函数并没有被调用, 也就是被优先级更高的 <code>EventListener</code> 截获了. </p>
<p>如果 <code>fixedPriority</code> 一样呢? 按照什么顺序? </p>
<ol>
<li><p><code>fixedPriority</code> 为0, 这个值是专门为 Scene Object 预留的. 即, 默认情况下, 绝大多数继承自 <code>Node</code> 的对象添加的普通事件监听器, 其 <code>fixedPriority</code> 都为0. 此时, <code>Node</code> 的 <code>globalZOrder</code>决定了优先级, 值越大, 越先被遍历到, 即在显示层中层级越高, 越先接受事件. 这在ui响应逻辑中也是合理的.</p>
</li>
<li><p><code>fixedPriority</code> 不为0, 那就按添加顺序. </p>
<h3 id="Event在什么条件下会被优先级更高的EventListener截获"><a href="#Event在什么条件下会被优先级更高的EventListener截获" class="headerlink" title="Event在什么条件下会被优先级更高的EventListener截获?"></a>Event在什么条件下会被优先级更高的EventListener截获?</h3></li>
<li><p>对于 <code>EventListenerTouchOneByOne</code>, 它有一个字段: <code>_needSwallow</code>, 当它为 <code>true</code> 的时候, 如果它接受了某个 <code>Event</code>, 优先级更低的 <code>EventListener</code> 就接受不到了. 可以用 <code>EventListenerTouchOneByOne::setSwallowTouches(bool needSwallow)</code> 来改变它.</p>
</li>
<li><p>对于其它类型的 <code>EventLIstener</code>, 只有在显示调用了 <code>Event::stopPropagation()</code> 的时候, 才会中断遍历.</p>
</li>
</ol>
<h2 id="核心函数-EventDispatcher-dispatchEvent"><a href="#核心函数-EventDispatcher-dispatchEvent" class="headerlink" title="核心函数: EventDispatcher::dispatchEvent()"></a>核心函数: EventDispatcher::dispatchEvent()</h2><p>下面我们看看<code>EventDispatcher</code>最核心的函数:<br><code>void EventDispatcher::dispatchEvent(Event* event)</code>: 当有响应的事件到来的时候, 都会调用这个函数来通知监听了此事件的对象.</p>
<p>其实, 上面的介绍, 已经把这个函数里绝大部分逻辑都描述了,这里做一个最后的总结<br>事件抛发的简要流程如下:</p>
<ol>
<li>检查 <code>_listenerMap</code> 中所有的<code>EventListnerVector</code>, 如果哪个容器的 <code>EventListener</code> 优先级顺序需要更新, 则重新排序</li>
<li>对于类型为 <code>Event::Type::TOUCH</code> 的事件, 则按照<a href="#priority_of_event_listener">EventListener的遍历顺序</a>遍历所有的 <code>EventListener</code>. 只有接受了 <code>EventTouch::EventCode::BEGAN</code> 事件的 <code>EventListener</code>, 才会收到其他类型的 <code>EventTouch</code> 事件.</li>
<li>对于其他类型的事件, 也按照<a href="#priority_of_event_listener">EventListener的遍历顺序</a>的顺序遍历对应的<code>EventListener</code>.</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><code>Eventdispatcher</code> 中的其它函数, 主要功能都是 添加<code>EventListener</code>, 删除<code>EventListener</code>等, 不做详细介绍. </p>
<p>总的来说, <code>Eventdispatcher</code> 是一个中转器:</p>
<ol>
<li>事件的产生模块儿, 只关心自己构造正确的 <code>Event</code>, 调用 <code>EventDispatcher::dispatchEvent(Event* event)</code> 交给 <code>EventDispatcher</code>.</li>
<li>需要监听事件的模块儿, 只需调用 <code>EventDispatcher::addEventListener(EventListener* listener)</code> (或者它的其它变种)来注册自己作为监听者.</li>
<li>而 <code>EventDispatcher</code> 的作用是: <ol start="4">
<li>把特定类型的 <code>Event</code> 送给对应类型的 <code>EventListener</code>.</li>
<li>对于同一种 <code>Event</code>, 规定了事件送达的优先级.</li>
</ol>
</li>
</ol>
<blockquote>
<p>Written with <a href="https://stackedit.io/" target="_blank" rel="noopener">StackEdit</a>.</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.bookbook.in/2014/07/22/%E6%8A%80%E6%9C%AF/[cocos2dx]%E6%B7%B1%E5%85%A5--%E5%87%A0%E4%B8%AA%E4%BB%A3%E8%A1%A8%E6%80%A7%E7%9A%84%E7%B1%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="知明所以">
      <meta itemprop="description" content="关系、健康、自由，是我的追求。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Book Book, Come in~">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2014/07/22/%E6%8A%80%E6%9C%AF/%5Bcocos2dx%5D%E6%B7%B1%E5%85%A5--%E5%87%A0%E4%B8%AA%E4%BB%A3%E8%A1%A8%E6%80%A7%E7%9A%84%E7%B1%BB/" class="post-title-link" itemprop="url">[cocos2dx]深入了解几个代表性的类</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2014-07-22 00:00:00" itemprop="dateCreated datePublished" datetime="2014-07-22T00:00:00+08:00">2014-07-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-01-13 13:00:17" itemprop="dateModified" datetime="2019-01-13T13:00:17+08:00">2019-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>摘要: 此文对<code>cocos2d-x</code>引擎中最具代表性,最能体现框架结构的几个类做了简单的介绍, 包括<code>Director</code>,<code>Application</code>, <code>Renderer</code>, <code>EventDispatcher</code>, <code>Scheduler</code>. 对于这些类, 也只对关系主要流程的方法做了介绍, 略过了容错代码和其它细节. 主要目的是让大家快速的对<code>cocos2d-x</code>引擎有一个全面笼统的认识, 也方便快速定位问题.</p>
<hr>
<h2 id="GLView"><a href="#GLView" class="headerlink" title="GLView"></a>GLView</h2><p><code>cocos2d-x</code>对<code>openGL</code>的封装. 不同平台下, <code>openGL</code>有一些差别.</p>
<h3 id="openGL"><a href="#openGL" class="headerlink" title="openGL"></a>openGL</h3><h4 id="一段简单的例子"><a href="#一段简单的例子" class="headerlink" title="一段简单的例子"></a>一段简单的例子</h4><p>以下内容引用自<a href="http://www.glprogramming.com/red/chapter01.html" target="_blank" rel="noopener">Introduction to OpenGL</a>. 需要更具体的介绍也可参考这个链接.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># include &lt;whateverYouNeed.h&gt;</span><br><span class="line">main() &#123;</span><br><span class="line">   InitializeAWindowPlease();</span><br><span class="line">   </span><br><span class="line">   glClearColor (0.0, 0.0, 0.0, 0.0);</span><br><span class="line">   glClear (GL_COLOR_BUFFER_BIT);</span><br><span class="line">   </span><br><span class="line">   glColor3f (1.0, 1.0, 1.0);</span><br><span class="line">   glOrtho(0.0, 1.0, 0.0, 1.0, -1.0, 1.0);</span><br><span class="line">   glBegin(GL_POLYGON);</span><br><span class="line">      glVertex3f (0.25, 0.25, 0.0);</span><br><span class="line">      glVertex3f (0.75, 0.25, 0.0);</span><br><span class="line">      glVertex3f (0.75, 0.75, 0.0);</span><br><span class="line">      glVertex3f (0.25, 0.75, 0.0);</span><br><span class="line">   glEnd();</span><br><span class="line">   glFlush();</span><br><span class="line">   </span><br><span class="line">   UpdateTheWindowAndCheckForEvents();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="OpenGL-Command-Syntax"><a href="#OpenGL-Command-Syntax" class="headerlink" title="OpenGL Command Syntax"></a>OpenGL Command Syntax</h4><ul>
<li>OpenGL commands use the prefix <code>gl</code> and initial capital letters for each word making up the command name </li>
<li>some seemingly extraneous letters appended to some command names (for example, the <code>3f</code> in <code>glColor3f()</code> and <code>glVertex3f()</code>)</li>
</ul>
<h4 id="OpenGL-as-a-State-Machine"><a href="#OpenGL-as-a-State-Machine" class="headerlink" title="OpenGL as a State Machine"></a>OpenGL as a State Machine</h4><p>OpenGL is a state machine. You put it into various states (or modes) that then remain in effect until you change them.</p>
<h2 id="Application"><a href="#Application" class="headerlink" title="Application"></a>Application</h2><h3 id="主要方法"><a href="#主要方法" class="headerlink" title="主要方法:"></a>主要方法:</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">virtual const char * getCurrentLanguage();</span><br><span class="line">virtual Platform getTargetPlatform();</span><br><span class="line">virtual void setAnimationInterval(double interval);</span><br><span class="line">int run();&#x2F;&#x2F;启动主循环</span><br></pre></td></tr></table></figure>
<h3 id="run-函数"><a href="#run-函数" class="headerlink" title="run()函数"></a>run()函数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">int Application::run()</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    while(!glview-&gt;windowShouldClose())</span><br><span class="line">    &#123;</span><br><span class="line">        QueryPerformanceCounter(&amp;nNow);</span><br><span class="line">        if (nNow.QuadPart - nLast.QuadPart &gt; _animationInterval.QuadPart)</span><br><span class="line">        &#123;</span><br><span class="line">            nLast.QuadPart &#x3D; nNow.QuadPart;</span><br><span class="line">            </span><br><span class="line">            director-&gt;mainLoop();       &#x2F;&#x2F;Director进行这一帧的渲染</span><br><span class="line">            glview-&gt;pollEvents();       &#x2F;&#x2F; This function processes only those events that have already been received and then returns immediately.</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            Sleep(0);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="Director"><a href="#Director" class="headerlink" title="Director"></a>Director</h2><h3 id="主要函数预览"><a href="#主要函数预览" class="headerlink" title="主要函数预览"></a>主要函数预览</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;openGL Matrix Operate</span><br><span class="line">    void pushMatrix(MATRIX_STACK_TYPE type);</span><br><span class="line">    void popMatrix(MATRIX_STACK_TYPE type);</span><br><span class="line">    void loadIdentityMatrix(MATRIX_STACK_TYPE type);</span><br><span class="line">    void loadMatrix(MATRIX_STACK_TYPE type, const Mat4&amp; mat);</span><br><span class="line">    void multiplyMatrix(MATRIX_STACK_TYPE type, const Mat4&amp; mat);</span><br><span class="line">    Mat4 getMatrix(MATRIX_STACK_TYPE type);</span><br><span class="line">    void resetMatrixStack();</span><br><span class="line">    </span><br><span class="line">&#x2F;&#x2F;View Data</span><br><span class="line">    inline double getAnimationInterval();</span><br><span class="line">    inline bool isDisplayStats();</span><br><span class="line">    inline GLView* getOpenGLView();</span><br><span class="line">    inline Projection getProjection();</span><br><span class="line">    Size getVisibleSize() const;</span><br><span class="line">    </span><br><span class="line">    Vec2 getVisibleOrigin() const;</span><br><span class="line">    Vec2 convertToGL(const Vec2&amp; point);</span><br><span class="line">    Vec2 convertToUI(const Vec2&amp; point);</span><br><span class="line">    float getZEye() const;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Scene 场景管理</span><br><span class="line">    inline Scene* getRunningScene();</span><br><span class="line">    void runWithScene(Scene *scene);</span><br><span class="line">    void pushScene(Scene *scene);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">&#x2F;&#x2F; 控制绘制的暂停和恢复</span><br><span class="line">    void end();</span><br><span class="line">    void pause();</span><br><span class="line">    void resume();</span><br><span class="line">    </span><br><span class="line">&#x2F;&#x2F;绘制图形(界面展示最重要的函数)</span><br><span class="line">    void drawScene();</span><br><span class="line">    </span><br><span class="line">&#x2F;&#x2F;Getter and Setter</span><br><span class="line">    Scheduler* getScheduler() const &#123; return _scheduler; &#125;</span><br><span class="line">    void setScheduler(Scheduler* scheduler);</span><br><span class="line"></span><br><span class="line">    ActionManager* getActionManager() const &#123; return _actionManager; &#125;</span><br><span class="line">    void setActionManager(ActionManager* actionManager);</span><br><span class="line">    </span><br><span class="line">    EventDispatcher* getEventDispatcher() const &#123; return _eventDispatcher; &#125;</span><br><span class="line">    void setEventDispatcher(EventDispatcher* dispatcher);</span><br><span class="line"></span><br><span class="line">    Renderer* getRenderer() const &#123; return _renderer; &#125;</span><br></pre></td></tr></table></figure>

<h3 id="drawScene-主要绘制函数"><a href="#drawScene-主要绘制函数" class="headerlink" title="drawScene(): 主要绘制函数"></a>drawScene(): 主要绘制函数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Draw the Scene</span><br><span class="line">void Director::drawScene()</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    if (! _paused)</span><br><span class="line">    &#123;</span><br><span class="line">        _scheduler-&gt;update(_deltaTime);                         &#x2F;&#x2F;Scheduler 定时器 更新</span><br><span class="line">        _eventDispatcher-&gt;dispatchEvent(_eventAfterUpdate);     &#x2F;&#x2F;Dispatcher 抛发事件.</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);         &#x2F;&#x2F;glClear</span><br><span class="line"></span><br><span class="line">    if (_nextScene)                                             &#x2F;&#x2F;取得下一个将要显示的Scene.</span><br><span class="line">    &#123;</span><br><span class="line">        setNextScene();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pushMatrix(MATRIX_STACK_TYPE::MATRIX_STACK_MODELVIEW);      &#x2F;&#x2F;将上一次绘制的Context放到堆栈</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; draw the scene</span><br><span class="line">    if (_runningScene)</span><br><span class="line">    &#123;</span><br><span class="line">        _runningScene-&gt;visit(_renderer, Mat4::IDENTITY, false);</span><br><span class="line">        _eventDispatcher-&gt;dispatchEvent(_eventAfterVisit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _renderer-&gt;render();                                        &#x2F;&#x2F;渲染</span><br><span class="line">    _eventDispatcher-&gt;dispatchEvent(_eventAfterDraw);</span><br><span class="line"></span><br><span class="line">    popMatrix(MATRIX_STACK_TYPE::MATRIX_STACK_MODELVIEW);       &#x2F;&#x2F;返回到上一次绘制时的状态.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; swap buffers</span><br><span class="line">    if (_openGLView)</span><br><span class="line">    &#123;</span><br><span class="line">        _openGLView-&gt;swapBuffers();                             &#x2F;&#x2F;把上面渲染的结果显示到屏幕</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Node-visit-函数"><a href="#Node-visit-函数" class="headerlink" title="Node::visit() 函数"></a>Node::visit() 函数</h2><h3 id="预览"><a href="#预览" class="headerlink" title="预览"></a>预览</h3><p>Node::visit() 的主要功能就是</p>
<ol>
<li>调用所有孩子的<code>visit</code>函数</li>
<li>调用<code>self-&gt;draw()</code>函数<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">void Node::visit(Renderer* renderer, const Mat4 &amp;parentTransform, uint32_t parentFlags)</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F; quick return if not visible. children won&#39;t be drawn.</span><br><span class="line">    if (!_visible)</span><br><span class="line">    &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    uint32_t flags &#x3D; processParentFlags(parentTransform, parentFlags);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; IMPORTANT:</span><br><span class="line">    &#x2F;&#x2F; To ease the migration to v3.0, we still support the Mat4 stack,</span><br><span class="line">    &#x2F;&#x2F; but it is deprecated and your code should not rely on it</span><br><span class="line">    Director* director &#x3D; Director::getInstance();</span><br><span class="line">    director-&gt;pushMatrix(MATRIX_STACK_TYPE::MATRIX_STACK_MODELVIEW);</span><br><span class="line">    director-&gt;loadMatrix(MATRIX_STACK_TYPE::MATRIX_STACK_MODELVIEW, _modelViewTransform);</span><br><span class="line"></span><br><span class="line">    int i &#x3D; 0;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    if(!_children.empty())</span><br><span class="line">    &#123;</span><br><span class="line">        sortAllChildren();</span><br><span class="line">        &#x2F;&#x2F; draw children zOrder &lt; 0</span><br><span class="line">        for( ; i &lt; _children.size(); i++ )</span><br><span class="line">        &#123;</span><br><span class="line">            auto node &#x3D; _children.at(i);</span><br><span class="line"></span><br><span class="line">            if ( node &amp;&amp; node-&gt;_localZOrder &lt; 0 )</span><br><span class="line">                node-&gt;visit(renderer, _modelViewTransform, flags);</span><br><span class="line">            else</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; self draw</span><br><span class="line">        this-&gt;draw(renderer, _modelViewTransform, flags);</span><br><span class="line"></span><br><span class="line">        for(auto it&#x3D;_children.cbegin()+i; it !&#x3D; _children.cend(); ++it)</span><br><span class="line">            (*it)-&gt;visit(renderer, _modelViewTransform, flags);</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        this-&gt;draw(renderer, _modelViewTransform, flags);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    director-&gt;popMatrix(MATRIX_STACK_TYPE::MATRIX_STACK_MODELVIEW);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="Node-draw"><a href="#Node-draw" class="headerlink" title="Node::draw()"></a>Node::draw()</h3><p>因为<code>Node</code>是所有可显示对象的父类, 没有任何显示内容, 所以<code>draw</code>函数为空.<br>这里我们以<code>Sprite::draw</code>函数为例简单介绍下<code>draw</code>的作用.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">void Sprite::draw(Renderer *renderer, const Mat4 &amp;transform, uint32_t flags)</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F; Don&#39;t do calculate the culling if the transform was not updated</span><br><span class="line">    _insideBounds &#x3D; (flags &amp; FLAGS_TRANSFORM_DIRTY) ? renderer-&gt;checkVisibility(transform, _contentSize) : _insideBounds;</span><br><span class="line"></span><br><span class="line">    if(_insideBounds)</span><br><span class="line">    &#123;</span><br><span class="line">        _quadCommand.init(_globalZOrder, _texture-&gt;getName(), getGLProgramState(), _blendFunc, &amp;_quad, 1, transform);</span><br><span class="line">        renderer-&gt;addCommand(&amp;_quadCommand);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看到, <code>Sprite::draw</code>函数主要实现了[添加一个<code>QuadCommand</code>到<code>Render</code>中去]的功能.<br>再看看<code>Label</code>的绘制函数.</p>
<h3 id="Label-draw"><a href="#Label-draw" class="headerlink" title="Label::draw"></a>Label::draw</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">void Label::draw(Renderer *renderer, const Mat4 &amp;transform, uint32_t flags)</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F; Don&#39;t do calculate the culling if the transform was not updated</span><br><span class="line">    _insideBounds &#x3D; (flags &amp; FLAGS_TRANSFORM_DIRTY) ? renderer-&gt;checkVisibility(transform, _contentSize) : _insideBounds;</span><br><span class="line"></span><br><span class="line">    if(_insideBounds) &#123;</span><br><span class="line">        _customCommand.init(_globalZOrder);</span><br><span class="line">        _customCommand.func &#x3D; CC_CALLBACK_0(Label::onDraw, this, transform, flags);</span><br><span class="line">        renderer-&gt;addCommand(&amp;_customCommand);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实, 跟<code>Sprite::draw</code>也差不多. 关键在于这个<code>RenderCommand</code>怎么构造和执行的.</p>
<h2 id="Renderer-渲染器"><a href="#Renderer-渲染器" class="headerlink" title="Renderer 渲染器"></a>Renderer 渲染器</h2><h3 id="主要函数预览-1"><a href="#主要函数预览-1" class="headerlink" title="主要函数预览"></a>主要函数预览</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">void initGLView();</span><br><span class="line"></span><br><span class="line">&#x2F;** Adds a &#96;RenderComamnd&#96; into the renderer *&#x2F;</span><br><span class="line">void addCommand(RenderCommand* command);</span><br><span class="line"></span><br><span class="line">&#x2F;** Adds a &#96;RenderComamnd&#96; into the renderer specifying a particular render queue ID *&#x2F;</span><br><span class="line">void addCommand(RenderCommand* command, int renderQueue);</span><br><span class="line"></span><br><span class="line">&#x2F;** Pushes a group into the render queue *&#x2F;</span><br><span class="line">void pushGroup(int renderQueueID);</span><br><span class="line"></span><br><span class="line">&#x2F;** Pops a group from the render queue *&#x2F;</span><br><span class="line">void popGroup();</span><br><span class="line"></span><br><span class="line">&#x2F;** Creates a render queue and returns its Id *&#x2F;</span><br><span class="line">int createRenderQueue();</span><br><span class="line"></span><br><span class="line">&#x2F;** Renders into the GLView all the queued &#96;RenderCommand&#96; objects *&#x2F;</span><br><span class="line">void render();</span><br></pre></td></tr></table></figure>
<p>可见它主要由两个功能:</p>
<ol>
<li>对<code>ReanderCommand</code>进行排序和分类管理</li>
<li>进行渲染:<code>render()</code></li>
</ol>
<h3 id="渲染函数Renderer-render"><a href="#渲染函数Renderer-render" class="headerlink" title="渲染函数Renderer::render()"></a>渲染函数Renderer::render()</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">void Renderer::render()</span><br><span class="line">&#123;</span><br><span class="line">   ...</span><br><span class="line">    </span><br><span class="line">    if (_glViewAssigned)</span><br><span class="line">    &#123;</span><br><span class="line">       ...</span><br><span class="line">        &#x2F;&#x2F;排列渲染队列</span><br><span class="line">        for (auto &amp;renderqueue : _renderGroups)</span><br><span class="line">        &#123;</span><br><span class="line">            renderqueue.sort();</span><br><span class="line">        &#125; </span><br><span class="line">        &#x2F;&#x2F;进行渲染</span><br><span class="line">        visitRenderQueue(_renderGroups[0]);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Renderer-visitRenderQueue"><a href="#Renderer-visitRenderQueue" class="headerlink" title="Renderer::visitRenderQueue"></a>Renderer::visitRenderQueue</h3><p>按照顺序执行所有的 <code>RenderCommand</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">void Renderer::visitRenderQueue(const RenderQueue&amp; queue)</span><br><span class="line">&#123;</span><br><span class="line">    ssize_t size &#x3D; queue.size();</span><br><span class="line">    </span><br><span class="line">    for (ssize_t index &#x3D; 0; index &lt; size; ++index)</span><br><span class="line">    &#123;</span><br><span class="line">        auto command &#x3D; queue[index];</span><br><span class="line">        auto commandType &#x3D; command-&gt;getType();</span><br><span class="line">        if(RenderCommand::Type::QUAD_COMMAND &#x3D;&#x3D; commandType)</span><br><span class="line">        &#123;</span><br><span class="line">            auto cmd &#x3D; static_cast&lt;QuadCommand*&gt;(command);</span><br><span class="line">            &#x2F;&#x2F;Batch quads</span><br><span class="line">            if(_numQuads + cmd-&gt;getQuadCount() &gt; VBO_SIZE)</span><br><span class="line">            &#123;</span><br><span class="line">                drawBatchedQuads();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            _batchedQuadCommands.push_back(cmd);</span><br><span class="line">            </span><br><span class="line">            memcpy(_quads + _numQuads, cmd-&gt;getQuads(), sizeof(V3F_C4B_T2F_Quad) * cmd-&gt;getQuadCount());</span><br><span class="line">            convertToWorldCoordinates(_quads + _numQuads, cmd-&gt;getQuadCount(), cmd-&gt;getModelView());</span><br><span class="line">            </span><br><span class="line">            _numQuads +&#x3D; cmd-&gt;getQuadCount();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        else if(RenderCommand::Type::GROUP_COMMAND &#x3D;&#x3D; commandType)</span><br><span class="line">        &#123;</span><br><span class="line">            flush();</span><br><span class="line">            int renderQueueID &#x3D; ((GroupCommand*) command)-&gt;getRenderQueueID();</span><br><span class="line">            visitRenderQueue(_renderGroups[renderQueueID]);</span><br><span class="line">        &#125;</span><br><span class="line">        else if(RenderCommand::Type::CUSTOM_COMMAND &#x3D;&#x3D; commandType)</span><br><span class="line">        &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="openGL-VAO-VBO-介绍"><a href="#openGL-VAO-VBO-介绍" class="headerlink" title="openGL VAO, VBO 介绍."></a>openGL VAO, VBO 介绍.</h3><p><a href="http://blog.csdn.net/xiajun07061225/article/details/7628146" target="_blank" rel="noopener">GLSL渲染语言入门与VBO、VAO使用：绘制一个三角形</a><br><a href="http://blog.csdn.net/zhuyingqingfen/article/details/19238651" target="_blank" rel="noopener">OpenGL 4.0 VAO VBO 理解</a></p>
<h2 id="Schelduler介绍"><a href="#Schelduler介绍" class="headerlink" title="Schelduler介绍"></a>Schelduler介绍</h2><p><code>Schelduler</code>是<code>cocos2d-x</code>中实现延迟调用,定时调用时最重要的功能. 类似于其他语言中的<code>Timer</code><br>他最核心的函数就是:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">void schedule(const ccSchedulerFunc&amp; callback, void *target, float interval, unsigned int repeat, float delay, bool paused, const std::string&amp; key);</span><br></pre></td></tr></table></figure>

<p>用来启动一个定时操作: 在延迟<code>delay</code>时间后, 每隔<code>repeat</code>时间, 调用一次<code>callback</code>. <code>target</code>用来标记这个操作属于谁, 方便管理, 比如在析构的时候调用<code>void unschedule(void *target)</code>即可移除当前对象的所有<code>定时操作</code>.</p>
<p><code>Schelduler</code>的其它大部分方法, 要么是它的衍生, 为了减少调用参数; 要么是对<code>定时操作</code>的控制, 比如暂停, 恢复, 移除等. 如果只对想对框架的各个模块有大概的了解, 可以不做深入.</p>
<h2 id="EventDispatcher"><a href="#EventDispatcher" class="headerlink" title="EventDispatcher"></a>EventDispatcher</h2><p>(后续添加)</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.bookbook.in/2014/06/20/%E6%8A%80%E6%9C%AF/[cocos2dx]%E5%88%A9%E7%94%A8NDK%E5%B4%A9%E6%BA%83%E6%97%A5%E5%BF%97%E6%9F%A5%E6%89%BEBUG/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="知明所以">
      <meta itemprop="description" content="关系、健康、自由，是我的追求。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Book Book, Come in~">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2014/06/20/%E6%8A%80%E6%9C%AF/%5Bcocos2dx%5D%E5%88%A9%E7%94%A8NDK%E5%B4%A9%E6%BA%83%E6%97%A5%E5%BF%97%E6%9F%A5%E6%89%BEBUG/" class="post-title-link" itemprop="url">[cocos2dx]利用NDK崩溃日志查找BUG</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2014-06-20 00:00:00" itemprop="dateCreated datePublished" datetime="2014-06-20T00:00:00+08:00">2014-06-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-01-13 13:00:17" itemprop="dateModified" datetime="2019-01-13T13:00:17+08:00">2019-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>摘要: 在android上开发c++应用, crash日志都是汇编码, 很难对应到c++代码中去. 通过此文, 你可以定位到程序崩溃时的C++代码, 精确查找问题.</p>
<h3 id="背景介绍"><a href="#背景介绍" class="headerlink" title="背景介绍"></a>背景介绍</h3><ol>
<li><p>本文主要内容: 利用android的crash log来对c++开发的android应用进行错误定位.  </p>
</li>
<li><p>容易稳定复现的BUG, 一般可以通过断点调试来解决. 如果测试人员也无法稳定复现, <strong>log就成了程序吊定位问题的救命稻草</strong>. </p>
</li>
<li><p>通用操作系统都有自己的日志系统, android也不例外. 救命稻草已经给你了~ ( <a href="#how_to_refer_android_log">怎样查看android的系统日志</a> )  </p>
</li>
<li><p>但是, android的系统日志在c++代码崩溃时, 打印的都是内存地址和寄存器. 比如, 这样:</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">06-20 15:54:35.331 23889 23889 I DEBUG   : *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***</span><br><span class="line">06-20 15:54:35.331 23889 23889 I DEBUG   : Build fingerprint: &#39;google&#x2F;razorg&#x2F;deb:4.4.2&#x2F;KOT49H&#x2F;937116:user&#x2F;release-keys&#39;</span><br><span class="line">06-20 15:54:35.331 23889 23889 I DEBUG   : Revision: &#39;0&#39;</span><br><span class="line">06-20 15:54:35.331 23889 23889 I DEBUG   : pid: 1981, tid: 2020, name: Thread-3399  &gt;&gt;&gt; com.guangyou.ddgame &lt;&lt;&lt;</span><br><span class="line">06-20 15:54:35.331 23889 23889 I DEBUG   : signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 00000028</span><br><span class="line">06-20 15:54:35.431   187   710 D audio_hw_primary: out_set_parameters: enter: usecase(0: deep-buffer-playback) kvpairs: routing&#x3D;2</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :     r0 76d94458  r1 00000000  r2 00000000  r3 00000000</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :     r4 760c1a48  r5 751e2440  r6 00000001  r7 760c1a48</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :     r8 00000001  r9 76c96f3c  sl 76c861c0  fp 76d94444</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :     ip 00000001  sp 76d94430  lr 75a81bd8  pc 75a81bdc  cpsr 600f0010</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :     d0  746968775f327865  d1  6a6e6169642f675f</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :     d2  5f6f616978757169  d3  676e702e6e776f6d</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :     d4  0000000009000000  d5  0000000000000000</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :     d6  0000000000000000  d7  0000000000000000</span><br></pre></td></tr></table></figure>


<p>这密密麻麻的都是些神马, 是人看的么?</p>
<p>饿. 这个麻… 谁让你当程序猿! 让你当! 活该要看天书! </p>
<p>硬着头皮也要来, 我们就来讲讲怎么消化天书吧~</p>
<h3 id="怎样获取android的系统日志"><a href="#怎样获取android的系统日志" class="headerlink" title="怎样获取android的系统日志"></a>怎样获取android的系统日志<a id="how_to_refer_android_log"></a></h3><p> 假设你已经安装了 Android Develop Tools, 可以成功调用<code>adb</code>. 并打开android开发用机的调试模式, 连接到电脑.</p>
<p> 打开命令行, 在命令行输入: <code>adb logcat</code>. 就可以看到满屏幕的日志啦.<br> 输入<code>adb logcat --help</code>可以看到 <code>logcat</code>的用法提示.  </p>
<p> 这里有两个参数特别提醒一下, 比较常用:<br>    1. <code>-v XXXX</code>: 用来选择log输出样式, 一般建议 <code>threadtime</code>, 更加详细.<br>    2. <code>-d</code>: 让log一次性输出后马上完毕. 如果没有此命令, <code>logcat</code> 工具会一直输出, 即使更新在界面上. </p>
<p>如果需要保存log到文件, 方便以后查看. 可输入命令:<br><code>adb logcat -v threadtime -d &gt; log.txt</code></p>
<h3 id="理解NDK的crash-log"><a href="#理解NDK的crash-log" class="headerlink" title="理解NDK的crash log"></a>理解NDK的crash log</h3><p>如果你用c++开发的android应用在运行过程中, c++代码发生错误导致程序崩溃, 系统就会记录 crash log到上述的系统日志中. </p>
<p>下面是我正在开发的游戏一次崩溃后, 截取的日志( 插个广告, 全名斗地主下载地址: <a href="http://sj.ddwan.com" target="_blank" rel="noopener">http://sj.ddwan.com</a> )</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">06-20 15:54:35.331 23889 23889 I DEBUG   : *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***</span><br><span class="line">06-20 15:54:35.331 23889 23889 I DEBUG   : Build fingerprint: &#39;google&#x2F;razorg&#x2F;deb:4.4.2&#x2F;KOT49H&#x2F;937116:user&#x2F;release-keys&#39;</span><br><span class="line">06-20 15:54:35.331 23889 23889 I DEBUG   : Revision: &#39;0&#39;</span><br><span class="line">06-20 15:54:35.331 23889 23889 I DEBUG   : pid: 1981, tid: 2020, name: Thread-3399  &gt;&gt;&gt; com.guangyou.ddgame &lt;&lt;&lt;</span><br><span class="line">06-20 15:54:35.331 23889 23889 I DEBUG   : signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 00000028</span><br><span class="line">06-20 15:54:35.431   187   710 D audio_hw_primary: out_set_parameters: enter: usecase(0: deep-buffer-playback) kvpairs: routing&#x3D;2</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :     r0 76d94458  r1 00000000  r2 00000000  r3 00000000</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :     r4 760c1a48  r5 751e2440  r6 00000001  r7 760c1a48</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :     r8 00000001  r9 76c96f3c  sl 76c861c0  fp 76d94444</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :     ip 00000001  sp 76d94430  lr 75a81bd8  pc 75a81bdc  cpsr 600f0010</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :     d0  746968775f327865  d1  6a6e6169642f675f</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :     d2  5f6f616978757169  d3  676e702e6e776f6d</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :     d4  0000000009000000  d5  0000000000000000</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :     d6  0000000000000000  d7  0000000000000000</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :     d8  0000000000000000  d9  0000000000000000</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :     d10 0000000000000000  d11 0000000000000000</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :     d12 0000000000000000  d13 0000000000000000</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :     d14 0000000000000000  d15 0000000000000000</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :     d16 c3c3c3c3c3c3c3c3  d17 c3c3c3c3c3c3c3c3</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :     d18 41c7ddc227000000  d19 3ff0000000000000</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :     d20 3f811110896efbb2  d21 3fd7096611460fdb</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :     d22 c0176a8ee0000000  d23 bfc5230c760b0605</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :     d24 0000000000000000  d25 3fc7922925a107e2</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :     d26 3fdaa0f8fab43e33  d27 3fb43ad076b251ab</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :     d28 3fa15cb6bdc3c156  d29 3ec6cd878c3b46a7</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :     d30 3f65f3b6b9b97e01  d31 3ef99342e0ee5069</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :     scr 20000012</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   : backtrace:</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :     #00  pc 0089cbdc  &#x2F;data&#x2F;app-lib&#x2F;com.guangyou.ddgame-1&#x2F;libcocos2dcpp.so (cocos2d::Texture2D::getContentSize() const+32)</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :     #01  pc 0088f8dc  &#x2F;data&#x2F;app-lib&#x2F;com.guangyou.ddgame-1&#x2F;libcocos2dcpp.so (cocos2d::Sprite::setTexture(std::string const&amp;)+128)</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :     #02  pc 007863dc  &#x2F;data&#x2F;app-lib&#x2F;com.guangyou.ddgame-1&#x2F;libcocos2dcpp.so (cocos2d::ui::Button::loadTextureDisabled(std::string const&amp;, cocos2d::ui::Widget::TextureResType)+336)</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   : stack:</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :          76d943f0  00000001</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :          76d943f4  4006bc0d  &#x2F;system&#x2F;lib&#x2F;libc.so (free+12)</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :          76d943f8  76a72c54</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :          76d943fc  75eca614  &#x2F;data&#x2F;app-lib&#x2F;com.guangyou.ddgame-1&#x2F;libcocos2dcpp.so</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :          76d94400  751c23c8  [anon:libc_malloc]</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :          76d94404  751c23c8  [anon:libc_malloc]</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :          76d94408  751c23c8  [anon:libc_malloc]</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :          76d9440c  75a749b4  &#x2F;data&#x2F;app-lib&#x2F;com.guangyou.ddgame-1&#x2F;libcocos2dcpp.so (cocos2d::Sprite::setTexture(cocos2d::Texture2D*)+128)</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :          76d94410  0000003d</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :          76d94414  00e8efc8</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :          76d94418  00000000</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :          76d9441c  00000000</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :          76d94420  00000000</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :          76d94424  76d94458  [stack:2020]</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :          76d94428  00000020</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :          76d9442c  76d94444  [stack:2020]</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :     #00  76d94430  00000000</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :          76d94434  76d94458  [stack:2020]</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :          76d94438  76a66184</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :          76d9443c  760c1a48  &#x2F;data&#x2F;app-lib&#x2F;com.guangyou.ddgame-1&#x2F;libcocos2dcpp.so</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :          76d94440  76d9447c  [stack:2020]</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :          76d94444  75a748e0  &#x2F;data&#x2F;app-lib&#x2F;com.guangyou.ddgame-1&#x2F;libcocos2dcpp.so (cocos2d::Sprite::setTexture(std::string const&amp;)+132)</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :     #01  76d94448  76d944ec  [stack:2020]</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :          76d9444c  793ff0e8  [anon:libc_malloc]</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :          76d94450  76a72c54</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :          76d94454  00000000</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :          76d94458  00000000</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :          76d9445c  00000000</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :          76d94460  00000000</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :          76d94464  00000000</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :          76d94468  00000000</span><br><span class="line">06-20 15:54:35.511 23889 23889 I DEBUG   :          76d9446c  00000000</span><br><span class="line">06-20 15:54:35.521 23889 23889 I DEBUG   :          76d94470  7b91dcf8  [anon:libc_malloc]</span><br><span class="line">06-20 15:54:35.521 23889 23889 I DEBUG   :          76d94474  78ce6c50  [anon:libc_malloc]</span><br><span class="line">06-20 15:54:35.521 23889 23889 I DEBUG   :          76d94478  76d944b4  [stack:2020]</span><br><span class="line">06-20 15:54:35.521 23889 23889 I DEBUG   :          76d9447c  7596b3e0  &#x2F;data&#x2F;app-lib&#x2F;com.guangyou.ddgame-1&#x2F;libcocos2dcpp.so (cocos2d::ui::Button::loadTextureDisabled(std::string const&amp;, cocos2d::ui::Widget::TextureResType)+340)</span><br><span class="line">06-20 15:54:35.521 23889 23889 I DEBUG   :     #02  76d94480  00000001</span><br><span class="line">06-20 15:54:35.521 23889 23889 I DEBUG   :          76d94484  00000000</span><br><span class="line">06-20 15:54:35.521 23889 23889 I DEBUG   :          76d94488  76d944ec  [stack:2020]</span><br><span class="line">06-20 15:54:35.521 23889 23889 I DEBUG   :          76d9448c  793fe780  [anon:libc_malloc]</span><br><span class="line">06-20 15:54:35.521 23889 23889 I DEBUG   :          76d94490  76d944f0  [stack:2020]</span><br><span class="line">06-20 15:54:35.521 23889 23889 I DEBUG   :          76d94494  793ff0e8  [anon:libc_malloc]</span><br><span class="line">06-20 15:54:35.521 23889 23889 I DEBUG   :          76d94498  00000001</span><br><span class="line">06-20 15:54:35.521 23889 23889 I DEBUG   :          76d9449c  4006bc0d  &#x2F;system&#x2F;lib&#x2F;libc.so (free+12)</span><br><span class="line">06-20 15:54:35.521 23889 23889 I DEBUG   :          76d944a0  76a72c54</span><br><span class="line">06-20 15:54:35.521 23889 23889 I DEBUG   :          76d944a4  75eca614  &#x2F;data&#x2F;app-lib&#x2F;com.guangyou.ddgame-1&#x2F;libcocos2dcpp.so</span><br><span class="line">06-20 15:54:35.521 23889 23889 I DEBUG   :          76d944a8  78ce6c50  [anon:libc_malloc]</span><br><span class="line">06-20 15:54:35.521 23889 23889 I DEBUG   :          76d944ac  78ce6c50  [anon:libc_malloc]</span><br><span class="line">06-20 15:54:35.521 23889 23889 I DEBUG   :          76d944b0  76d9455c  [stack:2020]</span><br><span class="line">06-20 15:54:35.521 23889 23889 I DEBUG   :          76d944b4  75924e54  &#x2F;data&#x2F;app-lib&#x2F;com.guangyou.ddgame-1&#x2F;libcocos2dcpp.so (cocostudio::ButtonReader::setPropsFromJsonDictionary(cocos2d::ui::Widget*, rapidjson::GenericValue&lt;rapidjson::UTF8&lt;char&gt;, rapidjson::MemoryPoolAllocator&lt;rapidjson::CrtAllocator&gt; &gt; const&amp;)+752)</span><br><span class="line">06-20 15:54:35.521 23889 23889 I DEBUG   :          76d944b8  00000000</span><br><span class="line">06-20 15:54:35.521 23889 23889 I DEBUG   :          76d944bc  78ce6c50  [anon:libc_malloc]</span><br><span class="line">06-20 15:54:35.521 23889 23889 I DEBUG   :</span><br><span class="line">06-20 15:54:35.521 23889 23889 I DEBUG   : memory near r0:</span><br><span class="line">06-20 15:54:35.521 23889 23889 I DEBUG   :     76d94438 76a66184 760c1a48 76d9447c 75a748e0</span><br><span class="line">06-20 15:54:35.521 23889 23889 I DEBUG   :     76d94448 76d944ec 793ff0e8 76a72c54 00000000</span><br><span class="line">...</span><br><span class="line">06-20 15:54:35.521 23889 23889 I DEBUG   :</span><br><span class="line">06-20 15:54:35.521 23889 23889 I DEBUG   : memory near r4:</span><br><span class="line">06-20 15:54:35.521 23889 23889 I DEBUG   :     760c1a28 760811c8 75ee318c 75ee3194 75ee319c</span><br><span class="line">06-20 15:54:35.521 23889 23889 I DEBUG   :     760c1a38 4006d091 75f9a1f4 75f4ee5c 75e8ea0c</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>下面来逐行解读:</p>
<ol>
<li>ndk crash log以<code>*** *** *** *** ***</code>开始.</li>
<li>第一行<code>Build fingerprint: &#39;google/razorg/deb:4.4.2/KOT49H/937116:user/release-keys&#39;</code> 指明了运行的Android版本, 如果您有多份crash dump的话这个信息就比较有用了.</li>
<li>接着一行显示的是当前的线程id(pid)和进程id(tid). 如果当前崩溃的线程是主线程的话, pid和tid会是一样的~</li>
<li>第四行, 显示的是unix信号. 这里的<code>signal 11</code>, 即<code>SIGSEGV</code>, 表示段错误, 是最常见的信号.(<a href="http://zh.wikipedia.org/wiki/%E4%BF%A1%E5%8F%B7_(%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6)" target="_blank" rel="noopener">什么是unix信号</a>, <a href="http://zh.wikipedia.org/wiki/SIGSEGV" target="_blank" rel="noopener">什么是<code>SIGSEGV</code></a>)</li>
<li>接下来的部分是系统寄存器的dump信息.  <table>
<thead>
<tr>
<th align="left">符号</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td align="left">rX(X=[0~9])</td>
<td>代表整数寄存器</td>
</tr>
<tr>
<td align="left">dX(X=[0~31])</td>
<td>是浮点指针寄存器</td>
</tr>
<tr>
<td align="left">fp (or r11)</td>
<td>指向当前正在执行的函数的堆栈底.</td>
</tr>
<tr>
<td align="left">ip (or r12)</td>
<td>一个寄存器, 我也没弄明白是干啥的.</td>
</tr>
<tr>
<td align="left">sp (or r13)</td>
<td>当前正在执行的函数的堆栈顶.(跟fp相对应)</td>
</tr>
<tr>
<td align="left">lr (or r14)</td>
<td><a href="http://en.wikipedia.org/wiki/Link_register" target="_blank" rel="noopener">link register</a>. 简单来说, 当当前指令执行完了, <br/>就会从这个寄存器获取地址, 来知道需要返回<br/>到哪里继续执行.</td>
</tr>
<tr>
<td align="left">pc (or r15)</td>
<td>program counter. 存放下一条指令的地址</td>
</tr>
<tr>
<td align="left">cpsr</td>
<td>Current Program Status Register. 表示当前<br/>运行环境和状态的一些字节位.</td>
</tr>
</tbody></table>
</li>
<li>Crash dump还包含PC之前和之后的一些内存字段.</li>
<li>最后, 是崩溃时的调用堆栈. 如果你执行的是debug版本, 还能还原一些c++代码.</li>
</ol>
<h3 id="利用ndk-stack定位崩溃代码"><a href="#利用ndk-stack定位崩溃代码" class="headerlink" title="利用ndk-stack定位崩溃代码"></a>利用ndk-stack定位崩溃代码</h3><p>上面的一些信息能简单的帮你定位以下问题. 如果信息量还不够大的话, 那就还有最后一招: 还原历史.</p>
<p><code>Android NDK</code>自从版本R6开始, 提供了一个工具<code>ndk-stack</code>( 在目录<code>{ndk_root}/</code>中 ). 这个工具能自动分析dump下来的crash log, 将崩溃时的调用内存地址和c++代码一行一行对应起来.</p>
<p>我们先看一下用法, 执行命令<code>ndk-stack --help</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Usage:</span><br><span class="line">   ndk-stack -sym &lt;path&gt; [-dump &lt;path&gt;]</span><br><span class="line"></span><br><span class="line">      -sym  Contains full path to the root directory for symbols.</span><br><span class="line">      -dump Contains full path to the file containing the crash dump.</span><br><span class="line">            This is an optional parameter. If ommited, ndk-stack will</span><br><span class="line">            read input data from stdin</span><br></pre></td></tr></table></figure>
<ul>
<li>-dump参数很容易理解, 即dump下来的log文本文件. <code>ndk-stack</code>会分析此文件.</li>
<li>-sym参数就是你android项目下,编译成功之后,<code>obj</code>目录下的文件.</li>
</ul>
<p>下面我们就来示范一下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ adb logcat | ndk-stack -sym .&#x2F;obj&#x2F;local&#x2F;armeabi</span><br><span class="line">********** Crash dump: **********</span><br><span class="line">Build fingerprint: &#39;htc_wwe&#x2F;htc_bravo&#x2F;bravo:2.3.3&#x2F;</span><br><span class="line">GRI40&#x2F;96875.1:user&#x2F;release-keys&#39;</span><br><span class="line">pid: 1723, tid: 1743  &gt;&gt;&gt; com.packtpub.droidblaster &lt;&lt;&lt;</span><br><span class="line">signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 0000000c</span><br><span class="line">Stack frame #00  pc 00010a2c  &#x2F;data&#x2F;data&#x2F;com.packtpub.droidblaster&#x2F;lib&#x2F;libdroidblaster.so: Routine update in &#x2F;home&#x2F;packt&#x2F;Project&#x2F;Chapter11&#x2F;DroidBlaster_Part11&#x2F;jni&#x2F;TimeService.cpp:25</span><br><span class="line">Stack frame #01  pc 00009fcc  &#x2F;data&#x2F;data&#x2F;com.packtpub.droidblaster&#x2F;lib&#x2F;libdroidblaster.so: Routine onStep in &#x2F;home&#x2F;packt&#x2F;Project&#x2F;Chapter11&#x2F;DroidBlaster_Part11&#x2F;jni&#x2F;DroidBlaster.cpp:53</span><br><span class="line">Stack frame #02  pc 0000a348  &#x2F;data&#x2F;data&#x2F;com.packtpub.droidblaster&#x2F;lib&#x2F;libdroidblaster.so: Routine run in &#x2F;home&#x2F;packt&#x2F;Project&#x2F;Chapter11&#x2F;DroidBlaster_Part11&#x2F;jni&#x2F;EventLoop.cpp:49</span><br><span class="line">Stack frame #03  pc 0000f994  &#x2F;data&#x2F;data&#x2F;com.packtpub.droidblaster&#x2F;lib&#x2F;libdroidblaster.so: Routine android_main in &#x2F;home&#x2F;packt&#x2F;Project&#x2F;Chapter11&#x2F;DroidBlaster_Part11&#x2F;jni&#x2F;Main.cpp:31</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>熟悉的代码出现啦~~</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.bookbook.in/2014/04/18/%E7%AE%A1%E7%90%86/IT%E6%8A%80%E6%9C%AF%E5%9B%A2%E9%98%9F%E7%AE%A1%E7%90%86-%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="知明所以">
      <meta itemprop="description" content="关系、健康、自由，是我的追求。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Book Book, Come in~">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2014/04/18/%E7%AE%A1%E7%90%86/IT%E6%8A%80%E6%9C%AF%E5%9B%A2%E9%98%9F%E7%AE%A1%E7%90%86-%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">如何管理IT技术团队</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2014-04-18 00:00:00" itemprop="dateCreated datePublished" datetime="2014-04-18T00:00:00+08:00">2014-04-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-01-13 13:00:17" itemprop="dateModified" datetime="2019-01-13T13:00:17+08:00">2019-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%AE%A1%E7%90%86/" itemprop="url" rel="index">
                    <span itemprop="name">管理</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>摘要:此文是书籍《行之有效:IT技术团队管理之道》的读书笔记. 主要是方便自己回顾. 您也可以通过此文简要了解此书的内容.</p>
<h2 id="IT技术团队员工的特点"><a href="#IT技术团队员工的特点" class="headerlink" title="IT技术团队员工的特点"></a>IT技术团队员工的特点</h2><ol>
<li>高学历, 知识密集型. <strong>技术立身</strong>. </li>
<li><strong>人际关系简单</strong>. 摩擦大多数由技术产生, 相处也比较容易. </li>
<li>需要较高的<strong>自由度</strong>.( 经理的职能不是强迫人们工作, 而是让人自觉地工作 ). 一是希望完成任务之后能做自己的事情; 二是希望以自己的方式完成工作.</li>
<li><strong>发展前途</strong>. 没有发展前途, 就会离开.</li>
<li>敏感, 流动性大.</li>
</ol>
<h2 id="关于招聘的考量"><a href="#关于招聘的考量" class="headerlink" title="关于招聘的考量"></a>关于招聘的考量</h2><ol>
<li>技术能力满足基本要求</li>
<li>做事风格与团队匹配</li>
<li>沟通能力</li>
<li>工作努力.</li>
</ol>
<p>员工的本性很重要, 将来的塑造过程中很难改变.</p>
<h2 id="关于员工塑造"><a href="#关于员工塑造" class="headerlink" title="关于员工塑造"></a>关于员工塑造</h2><p>通常把员工看作是一员大将, 他们各自为团队镇守一方. 这样, 一个团队的战斗力才全面, 强劲.</p>
<p>另一个方面来讲, 一个人认为应该帮他(她)的人越多, 他的责任感就越小. 我们需要明确每一个人的责任.</p>
<h2 id="员工责任感与参与度"><a href="#员工责任感与参与度" class="headerlink" title="员工责任感与参与度"></a>员工责任感与参与度</h2><p>  一个人的积极性和责任感是性格的一部分, 虽然可以提高, 但是不要寄予太大的希望. 招聘的时候对这一方面要好好考察.</p>
<p>  管理者的一个重要责任就是<strong>让员工负责</strong>. 如果员工不明白自己的职责所在, 或者总认为自己可以部分责任, 管理者会很辛苦, 而且团队和项目会走向失败. </p>
<p>  员工会执行分配下来的任务, 但是会<strong>支持</strong>自己参与的事情. 简单的执行和内心的支持是不一样的.</p>
<p>  提高员工参与度的方法:</p>
<ol>
<li>外围的事情, 可以由”民主”决定.</li>
<li>日常的工作, 比如Code review也可以由员工参与</li>
<li>制定规则前, 征询大家的意见，最好能在会议中通过公开的讨论“诱导”大家得出此规则.</li>
</ol>
<h3 id="激发员工的责任感"><a href="#激发员工的责任感" class="headerlink" title="激发员工的责任感"></a>激发员工的责任感</h3><ul>
<li>第一个要素就是: 自己<strong>以身作则</strong>. 自己处处率先垂范, 不管怎么样的员工都会慢慢跟上.</li>
<li>光环理论: 如果你希望员工做到什么, 就要去表扬他们,好像他们已经做到了. 员工<strong>主动维护这个形象</strong>的力量是很大的.</li>
</ul>
<h2 id="权利和影响力"><a href="#权利和影响力" class="headerlink" title="权利和影响力"></a>权利和影响力</h2><h3 id="官方权利的基础上培养个人影响力"><a href="#官方权利的基础上培养个人影响力" class="headerlink" title="官方权利的基础上培养个人影响力"></a>官方权利的基础上培养个人影响力</h3><p>新管理者要给员工心理上接受和磨合的时间. ( 自己招聘的员工会有先天的”拥护”光环. )</p>
<p>管理者怎么提高个人影响力: </p>
<ol>
<li>专业能力要强</li>
<li>工作努力.( 风格可有差异 )</li>
<li>对人态度好, 公平, 关心员工. </li>
</ol>
<h3 id="分清楚管与不管的界限"><a href="#分清楚管与不管的界限" class="headerlink" title="分清楚管与不管的界限"></a>分清楚管与不管的界限</h3><p>一个典型的IT技术团队的管理者被授予的权利包括:</p>
<ol>
<li>团队日常管理</li>
<li>项目管理</li>
<li>绩效考核.</li>
<li>招聘新员工 ( 其中于技术相关的部分, 一部分的建议权 )</li>
<li>晋升, 加薪, 解雇等方面的建议权.</li>
</ol>
<p><strong>不包括</strong>:</p>
<ol>
<li>财务权</li>
<li>采购权</li>
<li>完全的人事权</li>
<li>参与公司商业活动</li>
<li>参与公司决策</li>
</ol>
<p>对于员工的关心, 原则是<strong>只管工作, 不管生活</strong>.<br>但是, 一个人情的社会, 必要的关心也不可缺少, 这里有一个比较简易的划分:</p>
<blockquote>
<p>每个人的生活中, 有两部分, 一是普通的生活, 称为公生活, 例如身体不适, 孩子上学, 回家探亲, 周末逛街, 等等. 另一个是私密生活, 包括宗教恋情, 婚姻状态, 性取向, 价值观, 人生观, 等等. 公生活可以谈论, 而且管理者应该主动关心公生活. 对于私生活, 即使员工主动提及, 也不要深入探究. </p>
</blockquote>
<h3 id="要约和领地"><a href="#要约和领地" class="headerlink" title="要约和领地"></a>要约和领地</h3><p>心理要约, 是指公司级管理者与员工达成的约定, 特别是没有明文规定的, 彼此在内心达成的一致.</p>
<p>领地, 可以通俗的理解为”地盘”. 员工都有自己的”领地”, 比如座位空间, 其负责的工作, 等等. 应该尽量尊重他们的”领地”.</p>
<p>史玉柱说:</p>
<blockquote>
<p>一定要尊重部下. 因为你这样做了, 他假如换个单位就碰不到这么好的领导. 所以遇到困难的时候他也不会走.<br>最重要的是你从内心深处一定要把他堪称是和你平等的人,有的老板会觉得你比我低一筹, 我是老板, 你是我的”马仔”. 假如你真的有这种想法, 必然会通过你的言行表现出来. 这样你周围的人必然不会跟你一条心. 人是对等的, 你一旦尊重他们, 他们就会更加尊重你.</p>
</blockquote>
<h3 id="关于个性"><a href="#关于个性" class="headerlink" title="关于个性"></a>关于个性</h3><p>一般来说, 比较稳妥的做法是, 管理者只在团队前展示相对中性的喜好和个人观点, 例如读书, 锻炼, 旅游, 等等. 容易引起争论的则要避免, 不要有意或者无意的在团队面前强调, 例如对宗教,民族,社会问题比较尖锐的立场等. </p>
<p>对于管理者来说, 包容下属以与自己不同的方式工作, 是一大挑战. 君子和而不同, 除非真的有必要, 管理者不要去干预员工的工作方式. </p>
<h2 id="保持距离"><a href="#保持距离" class="headerlink" title="保持距离"></a>保持距离</h2><blockquote>
<p>并不是对每一个人好, 就能获得尊重. 尊重原则, 有效执行, 才是管理的真谛.</p>
</blockquote>
<h2 id="随时激励"><a href="#随时激励" class="headerlink" title="随时激励"></a>随时激励</h2><p>每个人都需要激励. 激励有一个保鲜期, 所以要及时, 多次激励.</p>
<h2 id="考核"><a href="#考核" class="headerlink" title="考核"></a>考核</h2><blockquote>
<p>鼓励并没有错. 但是, 不同的人有不同的性格. 有的同事, 你要委婉一些. 有的同事, 你需要直接一些. 目标是一样的, 让他们能清楚的了解你的意思, 不用去猜. 在绩效考核的时候更要说得清楚, 否则, 会产生误解.</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://blog.bookbook.in/2014/03/29/%E6%8A%80%E6%9C%AF/[other]%E5%88%A9%E7%94%A8Google%20Speech%20API%E5%AE%9E%E7%8E%B0Speech%20To%20Text/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="知明所以">
      <meta itemprop="description" content="关系、健康、自由，是我的追求。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Book Book, Come in~">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2014/03/29/%E6%8A%80%E6%9C%AF/%5Bother%5D%E5%88%A9%E7%94%A8Google%20Speech%20API%E5%AE%9E%E7%8E%B0Speech%20To%20Text/" class="post-title-link" itemprop="url">利用Google Speech API实现Speech To Text</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2014-03-29 10:07:00" itemprop="dateCreated datePublished" datetime="2014-03-29T10:07:00+08:00">2014-03-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-01-13 13:00:17" itemprop="dateModified" datetime="2019-01-13T13:00:17+08:00">2019-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>简介：很久很久以前, 网上流传着一个<strong>免费的,识别率暴高的,稳定的</strong>Speech To Text API, 那就是Google Speech API. 但是最近再使用的时候,总是返回500 Error. 后来通过查看源码知道需要增加一个参数:<code>key=...</code>. 可能是为了防止滥用吧. 并且, 最近Chrome另外发布了一个<strong>长连接实时</strong>的识别接口, 这对开发者来说真是巨大的福音啊. 在这里主要对这两个接口的用法进行介绍.</p>
<h2 id="关键字"><a href="#关键字" class="headerlink" title="关键字"></a>关键字</h2><p><code>SpeechToText,API,google,STT,ASR,SR,speech,recognition</code></p>
<h2 id="申请Chromium-API-keys"><a href="#申请Chromium-API-keys" class="headerlink" title="申请Chromium API keys"></a>申请Chromium API keys</h2><p>本文使用的Google Speech API是为google自家的浏览器Chrome服务的. 可以通过这个Demo体验一下实际使用的效果: <a href="https://www.google.com/intl/en/chrome/demos/speech.html" target="_blank" rel="noopener">Google Speech To Text Demo</a>.<br>Chrome来源于开源项目Chromium. 为了方便开发者调试使用, google <strong><em>开放</em></strong>了这个STT(Speech to Text)接口. 但是, 因为这个借口只供调试使用, 所以在流量和次数上都有限制.并且, 不提供购买.  </p>
<p>好了, 背景介绍完毕, 我们来第一步: <strong><em>申请Chromium开发者权限</em></strong>.<br>具体步骤请参考<a href="http://www.chromium.org/developers/how-tos/api-keys" target="_blank" rel="noopener">how to get chromium API keys</a>). </p>
<blockquote>
<p><strong><em>Acquiring Keys</em></strong></p>
</blockquote>
<blockquote>
<ol>
<li>Make sure you are a member of <a href="mailto:chromium-dev@chromium.org">chromium-dev@chromium.org</a> (you can just subscribe to chromium-dev and choose not to receive mail).<br>For convenience, the APIs below are only visible to people subscribed to that group.</li>
<li>Make sure you are logged in with the Google account associated with the email address that you used to subscribe to chromium-dev.</li>
<li>Go to <a href="https://cloud.google.com/console" target="_blank" rel="noopener">https://cloud.google.com/console</a>(请使用旧版console)</li>
<li>Click the red Create project… button.</li>
<li>(Optional) You may add other members of your organization or team on the Team tab.</li>
<li>In the ‘APIs &amp; auth’ &gt; APIs tab, click the On/Off button to turn each of the following APIs to the On position, and read and agree to the Terms of Service that is shown:<br><br>(This list might be out of date; try searching for APIs starting with “Chrome” or having “for Chrome” in the name.)      * Chrome Remote Desktop API<ul>
<li>Chrome Spelling API</li>
<li>Chrome Suggest API</li>
<li>Chrome Sync API</li>
<li>Chrome Translate Element</li>
<li>Google Maps Geolocation API (requires enabling billing but is free to use; you can skip this one, in which case geolocation features of Chrome will not work)</li>
<li>Safe Browsing API</li>
<li><strong><em>Speech API</em></strong></li>
<li>Time Zone API</li>
<li>Google Cloud Messaging for Chrome</li>
<li>Google Now For Chrome API<br>If any of these APIs are not shown, recheck step 1.</li>
</ul>
</li>
<li>Go to the Credentials tab under the APIs &amp; auth tab.</li>
<li>Click the red Create New Client ID button in the OAuth section to create an OAuth 2.0 client ID.<ul>
<li>You want “Installed Application” for the Application type section</li>
<li>You want “Other” for the Installed application type section</li>
</ul>
</li>
<li>A new box should now appear titled “Client ID for installed applications”. In the next sections, we will refer to the values of the “Client ID” and “Client secret” fields in this box later (below).</li>
<li>Click the red Create New Key button in the Public API Access section and create a new Browser key.<br>You want to leave the box on the “Create a browser key and configure allowed referers” empty.</li>
<li>A new box should appear titled “Key for browser applications”. The next sections will refer to the value of the “API key” field too.</li>
</ol>
</blockquote>
<p>好了, 到这里, 我们已经获得了应用key, 在下文我们用<code>{key}</code>表示这个key.</p>
<h2 id="One-Shot-Recognition"><a href="#One-Shot-Recognition" class="headerlink" title="One Shot Recognition"></a>One Shot Recognition</h2><p>我们用<code>curl</code>来向服务器发送请求:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST \</span><br><span class="line">--data-binary @speech.flac \</span><br><span class="line">--user-agent &#39;Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10_6_8) AppleWebKit&#x2F;535.7 (KHTML, like Gecko) Chrome&#x2F;16.0.912.77 Safari&#x2F;535.7&#39; \</span><br><span class="line">--header &#39;Content-Type: audio&#x2F;x-flac; rate&#x3D;8000;&#39; \</span><br><span class="line">&#39;https:&#x2F;&#x2F;www.google.com&#x2F;speech-api&#x2F;v1&#x2F;recognize?client&#x3D;chromium&amp;lang&#x3D;zh-CN&amp;maxresults&#x3D;5&amp;pfilter&#x3D;0&amp;key&#x3D;AIzaSyC6Tkf4*****Q0CdISn-qnHhwLaS3cg2a0&#39;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">解释</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-X POST</td>
<td align="left">表示发送HTTP请求</td>
</tr>
<tr>
<td align="left">–data-binary @speech.flac</td>
<td align="left">发送音频文件<code>speech.flac</code></td>
</tr>
<tr>
<td align="left">–user-agent ‘…’</td>
<td align="left">http的参数,设置浏览器的<code>user-agent</code>信息</td>
</tr>
<tr>
<td align="left">–header</td>
<td align="left">http的参数. 指定了传送内容的类型(<code>audio/flac</code>)和音频频率(<code>8000Hz</code>). 注意, 只支持特定的几种频率(<code>8000Hz,4000Hz</code>还有几个记不清了),上传的flac文件频率要和参数一致.</td>
</tr>
<tr>
<td align="left"><a href="https://www.google.com/.../&amp;key=" target="_blank" rel="noopener">https://www.google.com/.../&amp;key=</a><br>AIzaSyC6Tkf*****Q0CdISn-qnHhwLaS3cg2a0</td>
<td align="left">http请求地址,其中最后一部分的key,应该替换为您申请的<code>{key}</code>.</td>
</tr>
</tbody></table>
<p>等待一分钟左右, 如果你运气好的话, 能看到如下结果:<br><img src="SpeechResult.jpg" alt="Result Image" title="ResultImage"></p>
<p>结果格式如下, 应该很清晰了吧:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;status&quot;: 0,</span><br><span class="line">    &quot;id&quot;: &quot;b3447b5d98c5653e0067f35b32c0a8ca-1&quot;,</span><br><span class="line">    &quot;hypotheses&quot;: </span><br><span class="line">    [</span><br><span class="line">    	&#123;</span><br><span class="line">        	&quot;utterance&quot;: &quot;i like pickles&quot;,</span><br><span class="line">        	&quot;confidence&quot;: 0.9012539</span><br><span class="line">    	&#125;,</span><br><span class="line">    	&#123;</span><br><span class="line">        	&quot;utterance&quot;: &quot;i like pickle&quot;</span><br><span class="line">    	&#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>如果您录音的格式不对的话, 可以用开源软件<code>sox</code>方便的转换格式和码率. 举个栗子:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sox .&#x2F;speech.mp3 -b 8 speech.flac trim 0 15</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">解释</th>
</tr>
</thead>
<tbody><tr>
<td align="left">./speech.mp3</td>
<td align="left">输入文件</td>
</tr>
<tr>
<td align="left">-b 8</td>
<td align="left">输出文件频率为 8kHz</td>
</tr>
<tr>
<td align="left">speech.flac</td>
<td align="left">输出文件名</td>
</tr>
<tr>
<td align="left">trim 0 15</td>
<td align="left">截取输入文件的0~15秒的部分, 输出出来</td>
</tr>
</tbody></table>
<h2 id="Stream-Recognition"><a href="#Stream-Recognition" class="headerlink" title="Stream Recognition"></a>Stream Recognition</h2><p>后来, Google 提供了更先进的live的双向的识别接口. 即同时打开两个HTTP连接, 一个负责实时发送(<code>POST</code>)音频流, 一个负责接受(<code>GET</code>).<br>这里有一个<code>PHP</code>版本的Demo. 可以参考实现您自己的<code>Stream Recognition</code>:<br><a href="http://mikepultz.com/2013/07/google-speech-api-full-duplex-php-version/" target="_blank" rel="noopener">Google Speech API – Full Duplex PHP Version</a></p>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用:"></a>引用:</h2><ol>
<li><p>Google Speech API – Full Duplex PHP Version<br><a href="http://mikepultz.com/2013/07/google-speech-api-full-duplex-php-version/" target="_blank" rel="noopener">http://mikepultz.com/2013/07/google-speech-api-full-duplex-php-version/</a></p>
</li>
<li><p>Accessing Google Speech API / Chrome 11<br><a href="http://mikepultz.com/2011/03/accessing-google-speech-api-chrome-11/" target="_blank" rel="noopener">http://mikepultz.com/2011/03/accessing-google-speech-api-chrome-11/</a></p>
</li>
<li><p>Google Speech To Text API ( 9 months ago )<br><a href="https://gist.github.com/alotaiba/1730160" target="_blank" rel="noopener">https://gist.github.com/alotaiba/1730160</a></p>
</li>
<li><p>避开Google Voice Search利用Google Speech API实现Android语音识别<br><a href="http://my.eoe.cn/sisuer/archive/5960.html" target="_blank" rel="noopener">http://my.eoe.cn/sisuer/archive/5960.html</a></p>
</li>
<li><p>How to Use Google Speech API( with sox )<br><a href="http://www.x2q.net/blog/2013/09/16/how-to-use-google-speech-api/" target="_blank" rel="noopener">http://www.x2q.net/blog/2013/09/16/how-to-use-google-speech-api/</a></p>
</li>
<li><p>Google Chomium Open Project<br><a href="http://src.chromium.org/viewvc/chrome/trunk/src/content/browser/speech/" target="_blank" rel="noopener">http://src.chromium.org/viewvc/chrome/trunk/src/content/browser/speech/</a><br><a href="http://src.chromium.org/viewvc/chrome/trunk/src/content/browser/speech/google_one_shot_remote_engine.cc" target="_blank" rel="noopener">http://src.chromium.org/viewvc/chrome/trunk/src/content/browser/speech/google_one_shot_remote_engine.cc</a></p>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">知明所以</p>
  <div class="site-description" itemprop="description">关系、健康、自由，是我的追求。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">75</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">236</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/zjh1943" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zjh1943" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:jhzhuustc@gmail.com" title="E-Mail → mailto:jhzhuustc@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">知明所以</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.7.0
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
